<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Plataforma de Dibujo Profesional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background-color: #f0f2f5;
        }

        #canvasContainer {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            cursor: none;
            background-color: #f0f2f5;
            user-select: none;
        }

        #canvasContainer.is-panning {
            cursor: grabbing;
        }

        #canvasContainer.pan-tool-active {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><path fill="rgba(0,0,0,0.8)" stroke="white" stroke-width="2" d="M15.7,28.3c-0.5,0-1-0.2-1.4-0.6c-0.8-0.8-0.8-2,0-2.8l3.4-3.4V12H9v5.2c0,1.1-0.9,2-2,2s-2-0.9,2-2V11c0-1.1,0.9,2,2-2h1V5c0-1.1,0.9-2,2-2s2,0.9,2,2v5h2V6c0-1.1,0.9-2,2-2s2,0.9,2,2v6h2V7c0-1.1,0.9-2,2-2s2,0.9,2,2v10c0,1.1-0.9,2-2,2h-1.8l3.6,3.6c0.8,0.8,0.8,2,0,2.8c-0.8,0.8-2,0.8-2.8,0l-3.6-3.6h-2.1l-3.4,3.4C16.7,28.1,16.2,28.3,15.7,28.3z"/></svg>') 16 16, grab;
        }

        .canvas-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            transform-origin: 0 0;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            touch-action: none;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
        }

        #side-bar {
            position: fixed;
            top: 50%;
            left: 1rem;
            transform: translateY(-50%);
            max-height: calc(100vh - 2rem);
            overflow-y: auto;
            border-radius: 1rem;
            z-index: 10;
            transition: width 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        #custom-cursor {
            position: fixed;
            pointer-events: none;
            z-index: 10000;
            border: 1px solid rgba(0, 0, 0, 0.8);
            background-color: rgba(100, 100, 100, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.05s ease, height 0.05s ease, border-radius 0.2s ease, background-color 0.1s, border-color 0.1s;
            display: none;
        }

        @media (hover: hover) and (pointer: fine) {
            body:not(.sidebar-hover) #custom-cursor {
                display: block;
            }
        }

        .action-btn {
            transition: background-color 0.2s ease, transform 0.15s ease, box-shadow 0.2s ease;
        }

        .action-btn:active {
            transform: translateY(0px) scale(0.98);
            background-color: #e5e7eb;
        }

        .tool-btn.active {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.39);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: scale(1) !important;
        }

        .color-swatch {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.1s;
        }

        .color-swatch.active {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px white;
            transform: scale(1.1);
        }

        #color-picker-trigger {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            background: conic-gradient(from 180deg at 50% 50%, #FF0000, #FFFF00, #00FF00, #00FFFF, #0000FF, #FF00FF, #FF0000);
        }

        #color-picker-input {
            display: none;
        }

        #side-bar.collapsed .sidebar-hidable { display: none; }
        #side-bar.collapsed .justify-start { justify-content: center; }

        .custom-slider { -webkit-appearance: none; appearance: none; width: 100%; height: 6px; background: #e5e7eb; border-radius: 3px; outline: none; }
        .custom-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: #3b82f6; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        .custom-slider::-moz-range-thumb { width: 18px; height: 18px; background: #3b82f6; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.2); }

        #page-gallery-modal { display: none; /* Estilos completos en el JS */ }

        /* --- ESTILOS PARA MÓVILES --- */
        @media (max-width: 768px) {
            #side-bar {
                top: 1rem;
                left: 1rem;
                transform: translateX(-120%);
                bottom: auto;
                max-height: calc(100vh - 2rem);
                padding: 0.75rem;
                background-color: rgba(255, 255, 255, 0.9);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }
            #side-bar.mobile-visible {
                transform: translateX(0);
            }
            #side-bar-content {
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
            }
             #tool-selection, #app-actions, #mobile-page-navigation, #mobile-view-controls {
                display: flex;
                flex-direction: row;
                overflow-x: auto;
                padding-bottom: 0.5rem;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }
             #tool-selection::-webkit-scrollbar, #app-actions::-webkit-scrollbar { display: none; }

            .sidebar-hidable, #menu-toggle-container { display: none !important; }

            .action-btn { flex-shrink: 0; padding: 0.75rem; justify-content: center; }
            .action-btn i { font-size: 1.5rem; }
            #tool-selection .action-btn, #app-actions .action-btn { width: 50px; height: 50px; }
            
            #tool-properties { display: flex; flex-direction: column; gap: 1rem; align-items: stretch; }
            #color-controls, #custom-colors-container { align-items: center; }
            #color-palette, #custom-colors-palette { justify-content: center; }
            #size-control, #opacity-control { padding: 0 0.5rem; }
            
            .custom-slider::-webkit-slider-thumb { width: 24px; height: 24px; }
            .custom-slider::-moz-range-thumb { width: 24px; height: 24px; }
        }
    </style>
</head>

<body>
    <!-- Botón para abrir el menú en móvil -->
    <button id="mobile-menu-toggle" class="md:hidden fixed top-4 left-4 z-20 p-3 bg-white/80 backdrop-blur-md rounded-lg shadow-lg">
        <i class="ph ph-list text-2xl"></i>
    </button>
    
    <!-- Menú lateral (se convierte en el menú móvil) -->
    <aside id="side-bar" class="w-64 bg-white/80 backdrop-blur-md shadow-lg flex-col p-4 hidden md:flex">
        <div id="side-bar-content" class="flex-grow flex flex-col gap-2">
            <!-- Herramientas -->
            <div id="tool-selection" class="flex flex-col items-center gap-2">
                <h3 class="font-bold text-lg sidebar-hidable">Herramientas</h3>
                <button id="pan" class="action-btn tool-btn p-3 w-full flex justify-start items-center gap-3 rounded-lg" title="Mover"><i class="ph ph-hand text-2xl"></i><span class="sidebar-hidable">Mover</span></button>
                <button id="pencil" class="action-btn tool-btn p-3 w-full flex justify-start items-center gap-3 rounded-lg" title="Lápiz"><i class="ph ph-pencil-simple text-2xl"></i><span class="sidebar-hidable">Lápiz</span></button>
                <button id="marker" class="action-btn tool-btn p-3 w-full flex justify-start items-center gap-3 rounded-lg" title="Resaltador"><i class="ph ph-highlighter-circle text-2xl"></i><span class="sidebar-hidable">Resaltador</span></button>
                <button id="eraser" class="action-btn tool-btn p-3 w-full flex justify-start items-center gap-3 rounded-lg" title="Borrador"><i class="ph ph-eraser text-2xl"></i><span class="sidebar-hidable">Borrador</span></button>
            </div>
            <div class="w-full h-px bg-gray-200 my-2"></div>
            <!-- Propiedades -->
            <div id="tool-properties" class="flex flex-col items-center gap-4">
                <h3 class="font-bold text-lg sidebar-hidable">Propiedades</h3>
                <div id="color-controls" class="w-full flex flex-col items-center gap-4">
                    <div id="color-palette" class="w-full flex flex-wrap justify-center gap-2">
                        <button class="color-swatch" style="background-color: #000000;" data-color="#000000"></button>
                        <button class="color-swatch" style="background-color: #ef4444;" data-color="#ef4444"></button>
                        <button class="color-swatch" style="background-color: #3b82f6;" data-color="#3b82f6"></button>
                        <button class="color-swatch" style="background-color: #22c55e;" data-color="#22c55e"></button>
                    </div>
                    <div class="w-full flex justify-center items-center gap-2">
                        <button id="color-picker-trigger" title="Elegir color"></button>
                        <input type="color" id="color-picker-input">
                    </div>
                </div>
                <div id="size-control" class="w-full">
                    <div class="flex justify-between items-center sidebar-hidable mb-1"><label for="brushSize" class="text-sm font-medium">Grosor</label><span id="brushSizeValue" class="text-sm font-semibold">5px</span></div>
                    <input type="range" id="brushSize" min="1" max="100" class="w-full custom-slider">
                </div>
                <div id="opacity-control" class="w-full">
                    <div class="flex justify-between items-center sidebar-hidable mb-1"><label for="opacity" class="text-sm font-medium">Opacidad</label><span id="opacityValue" class="text-sm font-semibold">100%</span></div>
                    <input type="range" id="opacity" min="0.05" max="1" step="0.01" class="w-full custom-slider">
                </div>
            </div>
            <div class="w-full h-px bg-gray-200 my-2"></div>
            <!-- Acciones -->
            <div id="app-actions" class="flex flex-col items-center gap-2">
                 <button id="undo" class="action-btn p-3 w-full flex justify-start items-center gap-3 rounded-lg" title="Deshacer"><i class="ph ph-arrow-u-up-left text-2xl"></i><span class="sidebar-hidable">Deshacer</span></button>
                 <button id="redo" class="action-btn p-3 w-full flex justify-start items-center gap-3 rounded-lg" title="Rehacer"><i class="ph ph-arrow-u-down-right text-2xl"></i><span class="sidebar-hidable">Rehacer</span></button>
                 <button id="clear" class="action-btn p-3 w-full flex justify-start items-center gap-3 rounded-lg" title="Limpiar"><i class="ph ph-trash text-2xl"></i><span class="sidebar-hidable">Limpiar</span></button>
                 <button id="download" class="action-btn p-3 w-full flex justify-start items-center gap-3 rounded-lg" title="Descargar"><i class="ph ph-download-simple text-2xl"></i><span class="sidebar-hidable">Descargar</span></button>
            </div>

            <!-- Controles de Navegación y Vista (SOLO PARA MÓVIL) -->
            <div class="w-full md:hidden">
                <div class="w-full h-px bg-gray-200 my-2"></div>
                <h3 class="font-bold text-lg text-center mb-2">Navegación</h3>
                <div id="mobile-page-navigation" class="flex justify-center items-center gap-2 p-2">
                    <button id="prev-btn-mobile" class="action-btn p-3 rounded-lg" title="Página Anterior"><i class="ph ph-arrow-left text-2xl"></i></button>
                    <input type="number" id="page-indicator-input-mobile" min="1" max="43" value="1" class="w-16 text-center rounded-lg border border-gray-300">
                    <button id="next-btn-mobile" class="action-btn p-3 rounded-lg" title="Página Siguiente"><i class="ph ph-arrow-right text-2xl"></i></button>
                </div>
                <div class="w-full h-px bg-gray-200 my-2"></div>
                <h3 class="font-bold text-lg text-center mb-2">Vista</h3>
                <div id="mobile-view-controls" class="flex justify-center items-center gap-2 p-2">
                    <button id="zoom-out-btn-mobile" class="action-btn p-3 rounded-lg" title="Alejar"><i class="ph ph-minus text-2xl"></i></button>
                    <button id="zoom-reset-btn-mobile" class="action-btn p-3 rounded-lg" title="Ajustar"><i class="ph ph-arrows-out-cardinal text-2xl"></i></button>
                    <button id="zoom-in-btn-mobile" class="action-btn p-3 rounded-lg" title="Acercar"><i class="ph ph-plus text-2xl"></i></button>
                </div>
            </div>
        </div>
        <!-- Toggle de menú para escritorio -->
        <div id="menu-toggle-container" class="mt-4">
            <button id="menu-toggle" class="action-btn p-3 w-full flex justify-start items-center gap-3 rounded-lg" title="Contraer menú">
                <i id="toggle-icon" class="ph ph-caret-circle-left text-2xl"></i>
                <span class="sidebar-hidable">Contraer</span>
            </button>
        </div>
    </aside>

    <main id="canvasContainer">
        <div class="canvas-wrapper">
            <img id="backgroundImage" src="" alt="Material de estudio">
            <canvas id="drawingCanvas"></canvas>
            <canvas id="tempCanvas"></canvas>
        </div>
    </main>
    
    <!-- Controles inferiores (SOLO PARA ESCRITORIO) -->
    <div id="bottom-controls" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-20 gap-2 hidden md:flex">
        <div class="control-panel flex items-center gap-2 bg-white/80 backdrop-blur-md shadow-lg rounded-xl p-2">
            <button id="prev-btn" class="action-btn p-3 rounded-lg" title="Página Anterior"><i class="ph ph-arrow-left text-2xl"></i></button>
            <input type="number" id="page-indicator-input" min="1" max="43" value="1" class="w-20 text-center rounded-lg border border-gray-300">
            <button id="next-btn" class="action-btn p-3 rounded-lg" title="Página Siguiente"><i class="ph ph-arrow-right text-2xl"></i></button>
        </div>
        <div class="control-panel flex items-center gap-2 bg-white/80 backdrop-blur-md shadow-lg rounded-xl p-2">
            <button id="zoom-out-btn" class="action-btn p-3 rounded-lg" title="Alejar"><i class="ph ph-minus text-2xl"></i></button>
            <button id="zoom-reset-btn" class="action-btn p-3 rounded-lg" title="Ajustar"><i class="ph ph-arrows-out-cardinal text-2xl"></i></button>
            <button id="zoom-in-btn" class="action-btn p-3 rounded-lg" title="Acercar"><i class="ph ph-plus text-2xl"></i></button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('canvasContainer');
            const canvasWrapper = document.querySelector('.canvas-wrapper');
            const mainCanvas = document.getElementById('drawingCanvas');
            const tempCanvas = document.getElementById('tempCanvas');
            const mainCtx = mainCanvas.getContext('2d');
            const tempCtx = tempCanvas.getContext('2d');
            const backgroundImage = document.getElementById('backgroundImage');
            const sideBar = document.getElementById('side-bar');
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            
            const toolButtons = document.querySelectorAll('.tool-btn');
            const colorPickerInput = document.getElementById('color-picker-input');
            const colorSwatches = document.querySelectorAll('#color-palette .color-swatch');
            const brushSizeSlider = document.getElementById('brushSize');
            const opacitySlider = document.getElementById('opacity');

            let isDrawing = false, currentTool = 'pencil', currentStroke = [], startPos = {};
            const totalPages = 43, imagePath = 'img/';
            let currentPage = 1, drawingsData = {}, historyPerPage = {}, history = [], historyStep = -1;
            
            let zoom = 1, panX = 0, panY = 0;
            let isPanning = false, panStart = { x: 0, y: 0 };
            const MAX_ZOOM = 5, MIN_ZOOM = 0.2;
            let lastTouchDistance = null, touchCenter = null; 

            const toolSettings = {
                pan: {},
                pencil: { color: '#000000', size: 5, opacity: 1.0 },
                marker: { color: '#facc15', size: 25, opacity: 0.5 },
                eraser: { size: 20, opacity: 1.0 }
            };

            function hexToRgbaString(hex, alpha) { if (!/^#[0-9A-F]{6}$/i.test(hex)) return `rgba(0,0,0,${alpha})`; const r = parseInt(hex.slice(1, 3), 16); const g = parseInt(hex.slice(3, 5), 16); const b = parseInt(hex.slice(5, 7), 16); return `rgba(${r}, ${g}, ${b}, ${alpha})`; }
            
            function updateUIForTool(tool) {
                container.classList.toggle('pan-tool-active', tool === 'pan');
                if (tool === 'pan') return;
                const settings = toolSettings[tool];
                brushSizeSlider.value = settings.size;
                opacitySlider.value = settings.opacity;
                if (tool !== 'eraser') colorPickerInput.value = settings.color;
                
                document.getElementById('brushSizeValue').textContent = `${Math.round(settings.size)}px`;
                document.getElementById('opacityValue').textContent = `${Math.round(settings.opacity * 100)}%`;
                
                document.getElementById('color-controls').style.display = tool === 'eraser' ? 'none' : 'flex';
                document.getElementById('opacity-control').style.display = tool === 'eraser' ? 'none' : 'block';

                colorSwatches.forEach(swatch => {
                   swatch.classList.toggle('active', swatch.dataset.color.toLowerCase() === (settings.color || '').toLowerCase());
                });
            }

            function loadDrawingsFromStorage() { try { const saved = localStorage.getItem('geniusDrawings'); if (saved) drawingsData = JSON.parse(saved); } catch (e) { drawingsData = {}; } }
            function saveCurrentPageDrawing() { if (!isCanvasBlank(mainCanvas)) { drawingsData[currentPage] = mainCanvas.toDataURL(); } else { delete drawingsData[currentPage]; } try { localStorage.setItem('geniusDrawings', JSON.stringify(drawingsData)); } catch (e) {} }
            
            function loadPage(pageNumber) {
                const num = parseInt(pageNumber, 10);
                if (isNaN(num) || num < 1 || num > totalPages) { 
                    document.getElementById('page-indicator-input').value = currentPage;
                    document.getElementById('page-indicator-input-mobile').value = currentPage;
                    return; 
                }
                saveCurrentPageDrawing();
                currentPage = num;
                const img = new Image();
                img.src = `${imagePath}${currentPage}.svg`;
                img.onload = () => {
                    backgroundImage.src = img.src;
                    const { naturalWidth: w, naturalHeight: h } = img;
                    [mainCanvas, tempCanvas, backgroundImage].forEach(el => { el.width = w; el.height = h; el.style.width = `${w}px`; el.style.height = `${h}px`; });
                    mainCtx.clearRect(0, 0, w, h);
                     if (drawingsData[currentPage]) {
                        const drawingImg = new Image();
                        drawingImg.src = drawingsData[currentPage];
                        drawingImg.onload = () => { mainCtx.drawImage(drawingImg, 0, 0); loadHistoryForCurrentPage(); };
                    } else { loadHistoryForCurrentPage(); }
                    fitAndCenter();
                }
                updateNavUI();
            }
            function updateNavUI() { 
                [document.getElementById('page-indicator-input'), document.getElementById('page-indicator-input-mobile')].forEach(el => el.value = currentPage);
                [document.getElementById('prev-btn'), document.getElementById('prev-btn-mobile')].forEach(el => el.disabled = currentPage === 1);
                [document.getElementById('next-btn'), document.getElementById('next-btn-mobile')].forEach(el => el.disabled = currentPage === totalPages);
            }

            function loadHistoryForCurrentPage() { if (historyPerPage[currentPage]) { history = historyPerPage[currentPage].history; historyStep = historyPerPage[currentPage].step; } else { history = [mainCanvas.toDataURL()]; historyStep = 0; } updateHistoryButtons(); }
            function saveHistoryForCurrentPage() { historyPerPage[currentPage] = { history: [...history], step: historyStep }; }
            function updateHistoryButtons() { [document.getElementById('undo'), document.getElementById('redo')].forEach(el => el.disabled = historyStep <= 0); [document.getElementById('redo')].forEach(el => el.disabled = historyStep >= history.length - 1); }
            function isCanvasBlank(canvas) { return !canvas.getContext('2d').getImageData(0, 0, canvas.width, canvas.height).data.some(channel => channel !== 0); }
            function saveState() { history.length = historyStep + 1; history.push(mainCanvas.toDataURL()); historyStep++; saveHistoryForCurrentPage(); updateHistoryButtons(); }
            function restoreState() { if (history[historyStep]) { const img = new Image(); img.src = history[historyStep]; img.onload = () => { mainCtx.clearRect(0, 0, mainCanvas.width, mainCanvas.height); mainCtx.drawImage(img, 0, 0); }; } }
            function undoState() { if (historyStep > 0) { historyStep--; restoreState(); saveHistoryForCurrentPage(); updateHistoryButtons(); } }
            function redoState() { if (historyStep < history.length - 1) { historyStep++; restoreState(); saveHistoryForCurrentPage(); updateHistoryButtons(); } }

            function getPointerPos(e) { const rect = container.getBoundingClientRect(); const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; return { x: clientX - rect.left, y: clientY - rect.top }; }
            function screenToCanvas(pos) { return { x: (pos.x - panX) / zoom, y: (pos.y - panY) / zoom }; }
            function applyTransform() { canvasWrapper.style.transform = `translate(${panX}px, ${panY}px) scale(${zoom})`; }
            function getTouchDistance(touches) { const dx = touches[0].clientX - touches[1].clientX; const dy = touches[0].clientY - touches[1].clientY; return Math.sqrt(dx * dx + dy * dy); }
            function getTouchCenter(touches) { return { x: (touches[0].clientX + touches[1].clientX) / 2, y: (touches[0].clientY + touches[1].clientY) / 2 }; }

            function startDrawing(e) {
                 if (window.innerWidth <= 768 && sideBar.classList.contains('mobile-visible') && e.target.closest('#canvasContainer')) {
                    sideBar.classList.remove('mobile-visible');
                }
                if (e.touches && e.touches.length === 2) {
                    e.preventDefault();
                    isDrawing = false; isPanning = true;
                    lastTouchDistance = getTouchDistance(e.touches);
                    touchCenter = getTouchCenter(e.touches);
                    return;
                }
                if (currentTool === 'pan') {
                    isPanning = true;
                    const { clientX, clientY } = e.touches ? e.touches[0] : e;
                    panStart = { x: clientX - panX, y: clientY - panY };
                    container.classList.add('is-panning');
                    return;
                }
                isDrawing = true; 
                startPos = screenToCanvas(getPointerPos(e));
                currentStroke = [startPos];
            }

             function draw(e) {
                if (e.touches && e.touches.length === 2) {
                    e.preventDefault();
                    if (lastTouchDistance === null) { lastTouchDistance = getTouchDistance(e.touches); touchCenter = getTouchCenter(e.touches); return; }
                    
                    const newTouchDistance = getTouchDistance(e.touches);
                    const newTouchCenter = getTouchCenter(e.touches);
                    const zoomFactor = newTouchDistance / lastTouchDistance;
                    const smoothedZoomFactor = 1 + (zoomFactor - 1) * 0.2;
                    
                    adjustZoom(smoothedZoomFactor, newTouchCenter.x, newTouchCenter.y);
                    panX += newTouchCenter.x - touchCenter.x;
                    panY += newTouchCenter.y - touchCenter.y;
                    
                    applyTransform();
                    lastTouchDistance = newTouchDistance;
                    touchCenter = newTouchCenter;
                    return;
                }
                if (isPanning) {
                    const { clientX, clientY } = e.touches ? e.touches[0] : e;
                    panX = clientX - panStart.x;
                    panY = clientY - panStart.y;
                    applyTransform(); 
                    return;
                }
                if (!isDrawing) return; 
                e.preventDefault(); 
                const currentPos = screenToCanvas(getPointerPos(e));
                currentStroke.push(currentPos); 

                tempCtx.save();
                tempCtx.setTransform(1, 0, 0, 1, 0, 0);
                tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
                tempCtx.restore();
                
                tempCtx.setTransform(zoom, 0, 0, zoom, panX, panY);
                switch (currentTool) { case 'pencil': case 'marker': case 'eraser': drawSmoothedLine(tempCtx, currentStroke); break; } 
            }
            function stopDrawing() { 
                lastTouchDistance = null; touchCenter = null; 
                if (isPanning) { isPanning = false; container.classList.remove('is-panning'); return; } 
                if (!isDrawing) return; 
                isDrawing = false; 

                tempCtx.save();
                tempCtx.setTransform(1, 0, 0, 1, 0, 0);
                tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
                tempCtx.restore();
                
                mainCtx.setTransform(zoom, 0, 0, zoom, panX, panY);
                if (currentStroke.length < 2 && currentTool !== 'pan') { drawDot(mainCtx, startPos); } 
                else { switch (currentTool) { case 'pencil': case 'marker': case 'eraser': drawSmoothedLine(mainCtx, currentStroke); break; } } 
                saveState(); 
                saveCurrentPageDrawing(); 
            }

            function drawDot(ctx, pos) { applyToolStyles(ctx); ctx.beginPath(); const radius = (toolSettings[currentTool].size / 2) / zoom; ctx.arc(pos.x, pos.y, radius, 0, Math.PI * 2); ctx.fill(); }
            function applyToolStyles(ctx) { 
                const toolConfig = toolSettings[currentTool]; 
                ctx.lineWidth = toolConfig.size / zoom;
                if (currentTool === 'eraser') { ctx.globalCompositeOperation = 'destination-out'; } 
                else { const color = hexToRgbaString(toolConfig.color, toolConfig.opacity); ctx.strokeStyle = color; ctx.fillStyle = color; ctx.globalCompositeOperation = (currentTool === 'marker') ? 'multiply' : 'source-over'; } 
                ctx.lineCap = 'round'; ctx.lineJoin = 'round'; 
            }
            function drawSmoothedLine(ctx, points) { if (points.length < 2) return; applyToolStyles(ctx); ctx.beginPath(); ctx.moveTo(points[0].x, points[0].y); for (let i = 1; i < points.length - 2; i++) { const c = (points[i].x + points[i + 1].x) / 2; const d = (points[i].y + points[i + 1].y) / 2; ctx.quadraticCurveTo(points[i].x, points[i].y, c, d); } if (points.length > 1) { ctx.quadraticCurveTo(points[points.length - 2].x, points[points.length - 2].y, points[points.length - 1].x, points[points.length - 1].y); } ctx.stroke(); }
            
            function adjustZoom(factor, x, y) {
                const newZoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, zoom * factor)); if (newZoom === zoom) return;
                const rect = container.getBoundingClientRect();
                const mouseX = x === undefined ? rect.width / 2 : x;
                const mouseY = y === undefined ? rect.height / 2 : y;
                panX = mouseX - (mouseX - panX) * (newZoom / zoom);
                panY = mouseY - (mouseY - panY) * (newZoom / zoom);
                zoom = newZoom;
                applyTransform();
            }

            function fitAndCenter() {
                const containerWidth = container.clientWidth;
                const containerHeight = container.clientHeight;
                const imageWidth = backgroundImage.naturalWidth;
                const imageHeight = backgroundImage.naturalHeight;
                if (!imageWidth || !imageHeight) return;
                
                let availableWidth = containerWidth, availableHeight = containerHeight, offsetX = 0;
                
                if (window.innerWidth > 768) {
                    offsetX = sideBar.classList.contains('collapsed') ? 88 : 256;
                    availableWidth -= offsetX;
                }
                
                const scale = Math.min(availableWidth / imageWidth, availableHeight / imageHeight) * 0.95;
                zoom = scale;
                panX = offsetX + (availableWidth - imageWidth * scale) / 2;
                panY = (availableHeight - imageHeight * scale) / 2;
                applyTransform();
            }

            // --- Event Listeners ---
            ['mousedown', 'touchstart'].forEach(evt => container.addEventListener(evt, startDrawing, { passive: false }));
            ['mousemove', 'touchmove'].forEach(evt => container.addEventListener(evt, draw, { passive: false }));
            ['mouseup', 'touchend'].forEach(evt => window.addEventListener(evt, stopDrawing));
            
            toolButtons.forEach(button => { button.addEventListener('click', () => { currentTool = button.id; toolButtons.forEach(btn => btn.classList.remove('active')); button.classList.add('active'); updateUIForTool(currentTool); }); });
            colorPickerInput.addEventListener('input', e => { toolSettings[currentTool].color = e.target.value; updateUIForTool(currentTool); });
            colorSwatches.forEach(swatch => swatch.addEventListener('click', () => { toolSettings[currentTool].color = swatch.dataset.color; updateUIForTool(currentTool); }));
            brushSizeSlider.addEventListener('input', () => { toolSettings[currentTool].size = brushSizeSlider.value; updateUIForTool(currentTool); });
            opacitySlider.addEventListener('input', () => { toolSettings[currentTool].opacity = opacitySlider.value; updateUIForTool(currentTool); });
            
            document.getElementById('undo').addEventListener('click', undoState);
            document.getElementById('redo').addEventListener('click', redoState);
            document.getElementById('clear').addEventListener('click', () => { mainCtx.clearRect(0, 0, mainCanvas.width, mainCanvas.height); saveState(); saveCurrentPageDrawing(); });
            document.getElementById('download').addEventListener('click', () => { const link = document.createElement('a'); link.download = `apuntes-pagina-${currentPage}.png`; const tempC = document.createElement('canvas'); tempC.width = backgroundImage.naturalWidth; tempC.height = backgroundImage.naturalHeight; const temp_ctx = tempC.getContext('2d'); temp_ctx.drawImage(backgroundImage, 0, 0); temp_ctx.drawImage(mainCanvas, 0, 0); link.href = tempC.toDataURL(); link.click(); });
            
            function createButtonHandler(elementIds, handler) {
                elementIds.forEach(id => document.getElementById(id)?.addEventListener('click', handler));
                elementIds.forEach(id => document.getElementById(id)?.addEventListener('touchstart', (e) => { e.preventDefault(); handler(e); }, {passive: false}));
            }
            createButtonHandler(['prev-btn', 'prev-btn-mobile'], () => loadPage(currentPage - 1));
            createButtonHandler(['next-btn', 'next-btn-mobile'], () => loadPage(currentPage + 1));
            createButtonHandler(['zoom-in-btn', 'zoom-in-btn-mobile'], () => adjustZoom(1.1));
            createButtonHandler(['zoom-out-btn', 'zoom-out-btn-mobile'], () => adjustZoom(1 / 1.1));
            createButtonHandler(['zoom-reset-btn', 'zoom-reset-btn-mobile'], fitAndCenter);
            
            [document.getElementById('page-indicator-input'), document.getElementById('page-indicator-input-mobile')].forEach(el => el.addEventListener('change', () => loadPage(el.value)));

            mobileMenuToggle.addEventListener('click', (e) => { e.stopPropagation(); sideBar.classList.toggle('mobile-visible'); });
            sideBar.addEventListener('click', e => e.stopPropagation());
            
            // --- Inicialización ---
            window.addEventListener('resize', fitAndCenter);
            loadDrawingsFromStorage();
            loadPage(1);
            updateUIForTool(currentTool);
            document.getElementById(currentTool).classList.add('active');
        });
    </script>
</body>

</html>

