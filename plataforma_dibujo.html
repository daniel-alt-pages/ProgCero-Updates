<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Plataforma de Dibujo Profesional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        /* Estilos generales del cuerpo del documento */
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background-color: #f0f2f5;
        }

        /* Contenedor principal del lienzo de dibujo */
        #canvasContainer {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            cursor: none;
            /* Oculta el cursor por defecto para usar el personalizado */
            background-color: #f0f2f5;
            user-select: none;
            /* Evita la selección de texto/elementos no deseada */
        }

        #canvasContainer.is-panning {
            cursor: grabbing;
        }

        /* El cursor de la mano ahora es un SVG para mejor visibilidad */
        #canvasContainer.pan-tool-active {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><path fill="rgba(0,0,0,0.8)" stroke="white" stroke-width="2" d="M15.7,28.3c-0.5,0-1-0.2-1.4-0.6c-0.8-0.8-0.8-2,0-2.8l3.4-3.4V12H9v5.2c0,1.1-0.9,2-2,2s-2-0.9,2-2V11c0-1.1,0.9,2,2-2h1V5c0-1.1,0.9-2,2-2s2,0.9,2,2v5h2V6c0-1.1,0.9-2,2-2s2,0.9,2,2v6h2V7c0-1.1,0.9-2,2-2s2,0.9,2,2v10c0,1.1-0.9,2-2,2h-1.8l3.6,3.6c0.8,0.8,0.8,2,0,2.8c-0.8,0.8-2,0.8-2.8,0l-3.6-3.6h-2.1l-3.4,3.4C16.7,28.1,16.2,28.3,15.7,28.3z"/></svg>') 16 16, grab;
        }


        .canvas-wrapper {
            position: absolute;
            top: 0;
            /* Controlado por JS */
            left: 0;
            /* Controlado por JS */
            transform-origin: 0 0;
            /* Origen de la transformación para cálculos precisos */
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            touch-action: none;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
        }

        #drawingCanvas {
            z-index: 2;
            background-color: transparent;
        }

        #tempCanvas {
            z-index: 3;
            background-color: transparent;
        }

        #backgroundImage {
            z-index: 1;
        }

        /* Barra lateral de herramientas */
        #side-bar {
            position: fixed;
            top: 50%;
            left: 1rem;
            transform: translateY(-50%);
            max-height: calc(100vh - 2rem);
            overflow-y: auto;
            border-radius: 1rem;
            z-index: 10;
            transition: width 0.3s ease-in-out, transform 0.3s ease-in-out, box-shadow 0.3s, bottom 0.3s ease-in-out, opacity 0.3s ease-in-out;
            will-change: transform, opacity;
        }

        #side-bar::-webkit-scrollbar {
            width: 8px;
        }

        #side-bar::-webkit-scrollbar-track {
            background: transparent;
        }

        #side-bar::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        #custom-cursor {
            position: fixed;
            pointer-events: none;
            z-index: 10000;
            border: 1px solid rgba(0, 0, 0, 0.8);
            background-color: rgba(100, 100, 100, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.05s ease, height 0.05s ease, border-radius 0.2s ease, background-color 0.1s, border-color 0.1s;
            display: none;
        }

        @media (hover: hover) and (pointer: fine) {
            body:not(.sidebar-hover) #custom-cursor {
                display: block;
            }
        }

        #canvasContainer.cursor-precision {
            cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><circle cx='16' cy='16' r='1.5' fill='black'/><line x1='16' y1='0' x2='16' y2='12' stroke='black' stroke-width='1'/><line x1='16' y1='20' x2='16' y2='32' stroke='black' stroke-width='1'/><line x1='0' y1='16' x2='12' y2='16' stroke='black' stroke-width='1'/><line x1='20' y1='16' x2='32' y2='16' stroke='black' stroke-width='1'/></svg>") 16 16, crosshair;
        }

        .action-btn {
            transition: background-color 0.2s ease-in-out, transform 0.15s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .action-btn:hover {
            background-color: #f3f4f6;
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .action-btn:active {
            transform: translateY(0px) scale(0.98);
            background-color: #e5e7eb;
        }

        .tool-btn.active {
            background-color: #3b82f6;
            color: white;
            transform: translateY(-1px) scale(1.05);
            box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.39);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: scale(1) !important;
            background-color: #e5e7eb !important;
            box-shadow: none !important;
        }

        .color-swatch {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.1s;
            position: relative;
        }

        .color-swatch:hover {
            transform: scale(1.1);
        }

        .color-swatch.active {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px white;
            transform: scale(1.1);
        }

        #color-picker-trigger {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            padding: 0;
            cursor: pointer;
            transition: transform 0.2s;
            background: conic-gradient(from 180deg at 50% 50%, #FF0000, #FFFF00, #00FF00, #00FFFF, #0000FF, #FF00FF, #FF0000);
        }

        #color-picker-trigger:hover {
            transform: scale(1.1);
        }

        #color-picker-input {
            display: none;
        }

        #side-bar.collapsed .sidebar-hidable {
            display: none;
        }

        #side-bar.collapsed .justify-start {
            justify-content: center;
        }

        .sidebar-item {
            opacity: 0;
            transform: translateX(-15px);
            animation: slideIn 0.4s ease-out forwards;
        }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .custom-slider {
            --track-color: #e5e7eb;
            --thumb-color: #3b82f6;
            --thumb-highlight: white;
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: var(--track-color);
            border-radius: 3px;
            outline: none;
            opacity: 0.9;
            transition: opacity .2s;
        }

        .custom-slider:hover {
            opacity: 1;
        }

        .custom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--thumb-color);
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid var(--thumb-highlight);
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }

        .custom-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: var(--thumb-color);
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid var(--thumb-highlight);
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }

        #page-indicator-input {
            width: 80px;
            text-align: center;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            font-weight: 600;
            padding: 0.25rem;
        }

        /* Estilos de la Galería de Páginas */
        #page-gallery-modal {
            display: none;
            /* Oculto por defecto */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .gallery-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 1rem;
        }

        .gallery-item {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 60px;
            height: 60px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s, transform 0.2s;
        }

        .gallery-item:hover {
            background-color: #f0f2f5;
            border-color: #3b82f6;
            transform: translateY(-2px);
        }

        .gallery-item.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        /* Contenedor para la navegación y controles de vista */
        #bottom-controls {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .control-panel {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border-radius: 0.75rem;
            padding: 0.5rem;
        }

        /* --- ESTILOS PARA MÓVILES --- */
        @media (max-width: 768px) {

            /* Controles de Página y Zoom (Barra inferior principal) */
            #bottom-controls {
                bottom: 0;
                left: 0;
                width: 100%;
                transform: translateX(0);
                /* Anular centrado de escritorio */
                padding: 0.5rem;
                background-color: rgba(255, 255, 255, 0.9);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                box-shadow: 0 -2px 15px rgba(0, 0, 0, 0.1);
                justify-content: space-between;
                /* Distribuir controles de página y zoom */
                border-top: 1px solid #e5e7eb;
                border-radius: 0;
                gap: 0.5rem;
            }

            .control-panel {
                background-color: transparent;
                box-shadow: none;
                padding: 0;
                gap: 0.25rem;
                flex-shrink: 1;
            }

            .control-panel .action-btn {
                padding: 0.5rem;
            }

            .control-panel .action-btn i {
                font-size: 1.5rem;
            }

            #page-indicator-input {
                width: 50px;
                font-size: 1rem;
            }

            #page-navigation {
                flex-grow: 1;
                justify-content: center;
            }

            #view-controls {
                flex-grow: 1;
                justify-content: center;
            }


            /* Barra de Herramientas y Propiedades (Barra flotante secundaria) */
            #side-bar {
                top: auto;
                bottom: 70px;
                /* Posicionada sobre la barra de controles inferior */
                left: 50%;
                transform: translateX(-50%);
                width: calc(100% - 2rem);
                max-width: 500px;
                height: auto;
                max-height: 45vh;
                /* Limita la altura para no cubrir toda la pantalla */
                overflow-y: auto;
                /* Desplazamiento vertical para propiedades */
                padding: 0.75rem;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            }

            #side-bar.mobile-hidden {
                transform: translateX(-50%) translateY(150%);
                opacity: 0;
                pointer-events: none;
            }

            #side-bar-content {
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
            }

            /* Hacer que los grupos de herramientas se desplacen horizontalmente */
            #tool-selection,
            #app-actions {
                display: flex;
                flex-direction: row;
                overflow-x: auto;
                padding-bottom: 0.5rem;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                /* Ocultar barra de scroll */
            }

            #tool-selection::-webkit-scrollbar,
            #app-actions::-webkit-scrollbar {
                display: none;
                /* Ocultar barra de scroll en Chrome/Safari */
            }


            /* Ocultar etiquetas de texto para ahorrar espacio */
            .sidebar-hidable {
                display: none;
            }

            .action-btn {
                flex-shrink: 0;
                /* Evitar que los botones se encojan */
                padding: 0.75rem;
                justify-content: center;
            }

            .action-btn i {
                font-size: 1.5rem;
            }

            #tool-selection .action-btn,
            #app-actions .action-btn {
                width: 50px;
                height: 50px;
            }

            /* Propiedades de Herramienta (Color, Grosor, etc.) */
            #tool-properties {
                display: flex;
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            #color-controls,
            #custom-colors-container {
                align-items: center;
            }

            #color-palette,
            #custom-colors-palette {
                justify-content: center;
            }

            #size-control,
            #opacity-control {
                padding: 0 0.5rem;
            }

            /* Hacer los selectores deslizables más fáciles de tocar */
            .custom-slider::-webkit-slider-thumb {
                width: 24px;
                height: 24px;
            }

            .custom-slider::-moz-range-thumb {
                width: 24px;
                height: 24px;
            }

            /* Ocultar elementos de UI exclusivos de escritorio */
            #menu-toggle-container,
            #focus-mode {
                display: none !important;
            }
        }
    </style>
</head>

<body class="">
    <aside id="side-bar" class="w-64 bg-white/80 backdrop-blur-md shadow-lg flex flex-col p-4">
        <div id="side-bar-content" class="flex-grow flex flex-col gap-2">
            <div id="tool-selection" class="flex flex-col items-center gap-2">
                <h3 class="font-bold text-lg sidebar-hidable sidebar-item">Herramientas</h3>
                <button id="pan"
                    class="action-btn tool-btn p-3 w-full flex justify-start items-center gap-3 rounded-lg sidebar-item"
                    title="Mover"><i class="ph ph-hand text-2xl"></i><span class="sidebar-hidable">Mover</span></button>
                <button id="pencil"
                    class="action-btn tool-btn p-3 w-full flex justify-start items-center gap-3 rounded-lg sidebar-item"
                    title="Lápiz"><i class="ph ph-pencil-simple text-2xl"></i><span
                        class="sidebar-hidable">Lápiz</span></button>
                <button id="marker"
                    class="action-btn tool-btn p-3 w-full flex justify-start items-center gap-3 rounded-lg sidebar-item"
                    title="Resaltador"><i class="ph ph-highlighter-circle text-2xl"></i><span
                        class="sidebar-hidable">Resaltador</span></button>
                <button id="line"
                    class="action-btn tool-btn p-3 w-full flex justify-start items-center gap-3 rounded-lg sidebar-item"
                    title="Línea"><i class="ph ph-line-segment text-2xl"></i><span
                        class="sidebar-hidable">Línea</span></button>
                <button id="rectangle"
                    class="action-btn tool-btn p-3 w-full flex justify-start items-center gap-3 rounded-lg sidebar-item"
                    title="Rectángulo"><i class="ph ph-rectangle text-2xl"></i><span
                        class="sidebar-hidable">Rectángulo</span></button>
                <button id="eraser"
                    class="action-btn tool-btn p-3 w-full flex justify-start items-center gap-3 rounded-lg sidebar-item"
                    title="Borrador"><i class="ph ph-eraser text-2xl"></i><span
                        class="sidebar-hidable">Borrador</span></button>
            </div>

            <div class="w-full h-px bg-gray-200 my-2 sidebar-item"></div>

            <div id="tool-properties" class="flex flex-col items-center gap-4 sidebar-item">
                <h3 class="font-bold text-lg sidebar-hidable sidebar-item">Color</h3>
                <div id="color-controls" class="w-full flex flex-col items-center gap-4">
                    <div id="color-palette" class="w-full flex flex-wrap justify-center gap-2">
                        <button class="color-swatch" style="background-color: #000000;" data-color="#000000"></button>
                        <button class="color-swatch" style="background-color: #ef4444;" data-color="#ef4444"></button>
                        <button class="color-swatch" style="background-color: #3b82f6;" data-color="#3b82f6"></button>
                        <button class="color-swatch" style="background-color: #22c55e;" data-color="#22c55e"></button>
                        <button class="color-swatch" style="background-color: #facc15;" data-color="#facc15"></button>
                    </div>
                    <div class="w-full flex justify-center items-center gap-2">
                        <button id="color-picker-trigger" title="Elegir color"></button>
                        <input type="color" id="color-picker-input">
                        <button id="add-custom-color" class="action-btn p-2 rounded-lg" title="Guardar color"><i
                                class="ph ph-plus-circle text-2xl"></i></button>
                    </div>
                </div>
                <div id="custom-colors-container" class="w-full flex flex-col items-center gap-2">
                    <h4 class="font-semibold text-sm sidebar-hidable self-start">Mis Colores</h4>
                    <div id="custom-colors-palette" class="w-full flex flex-wrap justify-center gap-2">
                        <!-- Colores guardados se añadirán aquí -->
                    </div>
                </div>

                <div class="w-full h-px bg-gray-200 my-2 sidebar-item"></div>
                <h3 class="font-bold text-lg sidebar-hidable sidebar-item">Propiedades</h3>

                <div id="size-control" class="w-full">
                    <div class="flex justify-between items-center sidebar-hidable mb-1">
                        <label for="brushSize" class="text-sm font-medium text-gray-600">Grosor</label>
                        <span id="brushSizeValue" class="text-sm font-semibold text-gray-800 tabular-nums">5px</span>
                    </div>
                    <input type="range" id="brushSize" min="1" max="100" class="w-full custom-slider">
                </div>
                <div id="opacity-control" class="w-full">
                    <div class="flex justify-between items-center sidebar-hidable mb-1">
                        <label for="opacity" class="text-sm font-medium text-gray-600">Opacidad</label>
                        <span id="opacityValue" class="text-sm font-semibold text-gray-800 tabular-nums">100%</span>
                    </div>
                    <input type="range" id="opacity" min="0.05" max="1" step="0.01" class="w-full custom-slider">
                </div>
            </div>

            <div class="w-full h-px bg-gray-200 my-2 sidebar-item"></div>

            <div id="app-actions" class="flex flex-col items-center gap-2">
                <button id="clear"
                    class="action-btn p-3 w-full flex justify-start items-center gap-3 rounded-lg sidebar-item"
                    title="Limpiar Anotaciones"><i class="ph ph-trash text-2xl"></i><span
                        class="sidebar-hidable">Limpiar</span></button>
                <button id="undo"
                    class="action-btn p-3 w-full flex justify-start items-center gap-3 rounded-lg sidebar-item"
                    title="Deshacer"><i class="ph ph-arrow-u-up-left text-2xl"></i><span
                        class="sidebar-hidable">Deshacer</span></button>
                <button id="redo"
                    class="action-btn p-3 w-full flex justify-start items-center gap-3 rounded-lg sidebar-item"
                    title="Rehacer"><i class="ph ph-arrow-u-down-right text-2xl"></i><span
                        class="sidebar-hidable">Rehacer</span></button>
                <button id="download"
                    class="action-btn p-3 w-full flex justify-start items-center gap-3 rounded-lg sidebar-item"
                    title="Descargar con Apuntes"><i class="ph ph-download-simple text-2xl"></i><span
                        class="sidebar-hidable">Descargar</span></button>
                <button id="focus-mode"
                    class="action-btn p-3 w-full flex justify-start items-center gap-3 rounded-lg sidebar-item"
                    title="Modo Foco"><i class="ph ph-corners-out text-2xl"></i><span class="sidebar-hidable">Modo
                        Foco</span></button>
            </div>
        </div>

        <div id="menu-toggle-container" class="mt-4 sidebar-item">
            <button id="menu-toggle" class="action-btn p-3 w-full flex justify-start items-center gap-3 rounded-lg"
                title="Contraer menú">
                <i id="toggle-icon" class="ph ph-caret-circle-left text-2xl"></i>
                <span class="sidebar-hidable">Contraer</span>
            </button>
        </div>
    </aside>

    <main id="canvasContainer">
        <div class="canvas-wrapper">
            <img id="backgroundImage" src="" alt="Material de estudio">
            <canvas id="drawingCanvas"></canvas>
            <canvas id="tempCanvas"></canvas>
        </div>
    </main>

    <div id="bottom-controls">
        <div id="page-navigation" class="control-panel">
            <button id="prev-btn" class="action-btn p-3 rounded-lg" title="Página Anterior"><i
                    class="ph ph-arrow-left text-2xl"></i></button>
            <input type="number" id="page-indicator-input" min="1" max="43" value="1" class="text-gray-800">
            <button id="next-btn" class="action-btn p-3 rounded-lg" title="Página Siguiente"><i
                    class="ph ph-arrow-right text-2xl"></i></button>
            <button id="gallery-btn" class="action-btn p-3 rounded-lg" title="Galería de Páginas"><i
                    class="ph ph-grid-four text-2xl"></i></button>
        </div>
        <div class="control-panel md:hidden">
            <button id="toggle-tools-btn" class="action-btn p-3 rounded-lg tool-btn active" title="Herramientas"><i
                    class="ph ph-paint-brush-broad text-2xl"></i></button>
        </div>
        <div id="view-controls" class="control-panel">
            <button id="zoom-out-btn" class="action-btn p-3 rounded-lg" title="Alejar"><i
                    class="ph ph-minus text-2xl"></i></button>
            <button id="zoom-reset-btn" class="action-btn p-3 rounded-lg" title="Ajustar a Pantalla"><i
                    class="ph ph-arrows-out-cardinal text-2xl"></i></button>
            <button id="zoom-in-btn" class="action-btn p-3 rounded-lg" title="Acercar"><i
                    class="ph ph-plus text-2xl"></i></button>
        </div>
    </div>


    <div id="custom-cursor"></div>

    <button id="exit-focus-mode"
        class="hidden fixed top-4 left-4 z-20 p-3 bg-white/80 backdrop-blur-md rounded-lg shadow-lg hover:bg-gray-200"
        title="Mostrar menú">
        <i class="ph ph-corners-in text-2xl"></i>
    </button>

    <!-- Modal de la Galería de Páginas -->
    <div id="page-gallery-modal">
        <div class="gallery-content">
            <h2 class="text-2xl font-bold text-center mb-4">Galería de Páginas</h2>
            <div id="gallery-grid" class="gallery-grid"></div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Referencias a elementos del DOM ---
            const container = document.getElementById('canvasContainer');
            const canvasWrapper = document.querySelector('.canvas-wrapper');
            const mainCanvas = document.getElementById('drawingCanvas');
            const tempCanvas = document.getElementById('tempCanvas');
            const mainCtx = mainCanvas.getContext('2d');
            const tempCtx = tempCanvas.getContext('2d');
            const backgroundImage = document.getElementById('backgroundImage');

            const sideBar = document.getElementById('side-bar');
            const menuToggle = document.getElementById('menu-toggle');
            const toggleIcon = document.getElementById('toggle-icon');
            const toggleText = menuToggle.querySelector('span');
            const focusModeBtn = document.getElementById('focus-mode');
            const exitFocusModeBtn = document.getElementById('exit-focus-mode');
            const customCursor = document.getElementById('custom-cursor');
            const colorPickerTrigger = document.getElementById('color-picker-trigger');
            const colorPickerInput = document.getElementById('color-picker-input');
            const colorControls = document.getElementById('color-controls');
            const colorSwatches = document.querySelectorAll('#color-palette .color-swatch');
            const addCustomColorBtn = document.getElementById('add-custom-color');
            const customColorsPalette = document.getElementById('custom-colors-palette');
            const brushSizeSlider = document.getElementById('brushSize');
            const brushSizeValue = document.getElementById('brushSizeValue');
            const sizeControl = document.getElementById('size-control');
            const opacitySlider = document.getElementById('opacity');
            const opacityValue = document.getElementById('opacityValue');
            const opacityControl = document.getElementById('opacity-control');
            const toolButtons = document.querySelectorAll('.tool-btn');
            const undoBtn = document.getElementById('undo');
            const redoBtn = document.getElementById('redo');
            const clearBtn = document.getElementById('clear');
            const downloadBtn = document.getElementById('download');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const pageInput = document.getElementById('page-indicator-input');
            const galleryBtn = document.getElementById('gallery-btn');
            const galleryModal = document.getElementById('page-gallery-modal');
            const galleryGrid = document.getElementById('gallery-grid');
            const zoomInBtn = document.getElementById('zoom-in-btn');
            const zoomOutBtn = document.getElementById('zoom-out-btn');
            const zoomResetBtn = document.getElementById('zoom-reset-btn');
            const toggleToolsBtn = document.getElementById('toggle-tools-btn');


            // --- Estado de la aplicación ---
            let isDrawing = false, currentTool = 'pan', currentStroke = [], startPos = {};
            const totalPages = 43, imagePath = 'img/';
            let currentPage = 1, drawingsData = {}, historyPerPage = {}, history = [], historyStep = -1;
            let customColors = [];
            const MAX_CUSTOM_COLORS = 12;

            // --- Estado de Zoom y Desplazamiento ---
            let zoom = 1, panX = 0, panY = 0;
            let isPanning = false, panStart = { x: 0, y: 0 };
            const MAX_ZOOM = 5, MIN_ZOOM = 0.2;
            let lastTouchDistance = null, touchCenter = null; // Para gestos táctiles

            const toolSettings = {
                pan: {},
                pencil: { color: '#000000', size: 5, opacity: 1.0 },
                marker: { color: '#facc15', size: 25, opacity: 0.5 },
                line: { color: '#000000', size: 5, opacity: 1.0 },
                rectangle: { color: '#000000', size: 5, opacity: 1.0 },
                eraser: { size: 20, opacity: 1.0 }
            };

            // --- Funciones de UI ---
            function expandMenu() { sideBar.classList.remove('collapsed'); sideBar.style.width = '256px'; toggleIcon.classList.replace('ph-caret-circle-right', 'ph-caret-circle-left'); toggleText.textContent = 'Contraer'; }
            function collapseMenu() { sideBar.classList.add('collapsed'); sideBar.style.width = '88px'; toggleIcon.classList.replace('ph-caret-circle-left', 'ph-caret-circle-right'); toggleText.textContent = 'Expandir'; }
            function enterFocusMode() { sideBar.style.transform = 'translateY(-50%) translateX(-120%)'; exitFocusModeBtn.classList.remove('hidden'); }
            function exitFocusMode() { sideBar.style.transform = 'translateY(-50%)'; exitFocusModeBtn.classList.add('hidden'); }
            function hexToRgbaString(hex, alpha) { if (!/^#[0-9A-F]{6}$/i.test(hex)) return `rgba(0,0,0,${alpha})`; const r = parseInt(hex.slice(1, 3), 16); const g = parseInt(hex.slice(3, 5), 16); const b = parseInt(hex.slice(5, 7), 16); return `rgba(${r}, ${g}, ${b}, ${alpha})`; }

            function updateActiveColorSwatch(color) {
                document.querySelectorAll('.color-swatch').forEach(swatch => {
                    swatch.classList.toggle('active', swatch.dataset.color.toLowerCase() === color.toLowerCase());
                });
            }

            function updateUIForTool(tool) {
                container.classList.toggle('pan-tool-active', tool === 'pan');
                if (tool !== 'pan') { updateCustomCursor(); } else { customCursor.style.display = 'none'; }
                if (tool === 'pan') { return; }
                const settings = toolSettings[tool];
                brushSizeSlider.value = settings.size;
                brushSizeValue.textContent = `${Math.round(settings.size)}px`;
                if (tool === 'eraser') {
                    colorControls.style.display = 'none'; opacityControl.style.display = 'none';
                    sizeControl.style.display = 'block';
                } else {
                    opacitySlider.value = settings.opacity; opacityValue.textContent = `${Math.round(settings.opacity * 100)}%`;
                    colorControls.style.display = 'flex'; opacityControl.style.display = 'block';
                    sizeControl.style.display = 'block'; colorPickerInput.value = settings.color;
                    updateActiveColorSwatch(settings.color);
                }
            }

            function updateCustomCursor() {
                if (currentTool === 'pan') { customCursor.style.display = 'none'; return; }
                const settings = toolSettings[currentTool];
                const size = settings.size * zoom;
                const isPrecisionTool = ['line', 'rectangle'].includes(currentTool);
                if (isPrecisionTool) {
                    customCursor.style.display = 'none'; container.classList.add('cursor-precision');
                } else {
                    customCursor.style.display = 'block'; container.classList.remove('cursor-precision');
                    customCursor.style.width = `${size}px`; customCursor.style.height = `${size}px`;
                    if (currentTool === 'pencil' || currentTool === 'eraser') customCursor.style.borderRadius = '50%';
                    else if (currentTool === 'marker') customCursor.style.borderRadius = '4px';
                    if (currentTool === 'eraser') { customCursor.style.backgroundColor = 'rgba(255, 255, 255, 0.5)'; customCursor.style.borderColor = '#ef4444'; }
                    else { const previewOpacity = currentTool === 'marker' ? 0.7 : 0.5; customCursor.style.backgroundColor = hexToRgbaString(settings.color, previewOpacity); customCursor.style.borderColor = hexToRgbaString(settings.color, 1); }
                }
            }

            // --- Lógica de Páginas y Almacenamiento ---
            function loadDrawingsFromStorage() { try { const saved = localStorage.getItem('geniusDrawings'); if (saved) drawingsData = JSON.parse(saved); } catch (e) { console.error("Error al cargar dibujos:", e); drawingsData = {}; } }
            function saveCurrentPageDrawing() { if (!isCanvasBlank(mainCanvas)) { drawingsData[currentPage] = mainCanvas.toDataURL(); } else { delete drawingsData[currentPage]; } try { localStorage.setItem('geniusDrawings', JSON.stringify(drawingsData)); } catch (e) { console.error("Error al guardar dibujos:", e); } }
            function loadPage(pageNumber) {
                const num = parseInt(pageNumber, 10);
                if (isNaN(num) || num < 1 || num > totalPages) { pageInput.value = currentPage; return; }
                saveCurrentPageDrawing();
                currentPage = num;
                const img = new Image();
                img.src = `${imagePath}${currentPage}.svg`;
                img.onload = () => {
                    backgroundImage.src = img.src;
                    const canvasWidth = img.naturalWidth; const canvasHeight = img.naturalHeight;
                    [mainCanvas, tempCanvas, backgroundImage].forEach(el => { el.width = canvasWidth; el.height = canvasHeight; el.style.width = `${canvasWidth}px`; el.style.height = `${canvasHeight}px`; });
                    mainCtx.clearRect(0, 0, canvasWidth, canvasHeight);
                    if (drawingsData[currentPage]) { const drawingImg = new Image(); drawingImg.src = drawingsData[currentPage]; drawingImg.onload = () => { mainCtx.drawImage(drawingImg, 0, 0); loadHistoryForCurrentPage(); }; }
                    else { loadHistoryForCurrentPage(); }
                    fitAndCenter();
                }
                img.onerror = () => { console.error(`No se pudo cargar: ${imagePath}${currentPage}.svg`); backgroundImage.src = ""; };
                updateNavUI();
            }
            function updateNavUI() { pageInput.value = currentPage; prevBtn.disabled = currentPage === 1; nextBtn.disabled = currentPage === totalPages; }

            // --- Lógica del Historial ---
            function loadHistoryForCurrentPage() { if (historyPerPage[currentPage]) { history = historyPerPage[currentPage].history; historyStep = historyPerPage[currentPage].step; } else { history = [mainCanvas.toDataURL()]; historyStep = 0; } updateHistoryButtons(); }
            function saveHistoryForCurrentPage() { historyPerPage[currentPage] = { history: history, step: historyStep }; }
            function updateHistoryButtons() { undoBtn.disabled = historyStep <= 0; redoBtn.disabled = historyStep >= history.length - 1; }
            function isCanvasBlank(canvas) { return !canvas.getContext('2d').getImageData(0, 0, canvas.width, canvas.height).data.some(channel => channel !== 0); }
            function saveState() { historyStep++; if (historyStep < history.length) { history.length = historyStep; } history.push(mainCanvas.toDataURL()); saveHistoryForCurrentPage(); updateHistoryButtons(); }
            function restoreState() { if (history[historyStep]) { const img = new Image(); img.src = history[historyStep]; img.onload = () => { mainCtx.clearRect(0, 0, mainCanvas.width, mainCanvas.height); mainCtx.drawImage(img, 0, 0); }; } }
            function undoState() { if (historyStep > 0) { historyStep--; restoreState(); saveHistoryForCurrentPage(); updateHistoryButtons(); } }
            function redoState() { if (historyStep < history.length - 1) { historyStep++; restoreState(); saveHistoryForCurrentPage(); updateHistoryButtons(); } }

            // --- Lógica del Lienzo (Canvas) y Transformaciones ---
            function getTransformedPointerPos(e) { const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; const rect = canvasWrapper.getBoundingClientRect(); return { x: (clientX - rect.left) / zoom, y: (clientY - rect.top) / zoom }; }
            function applyTransform() { canvasWrapper.style.transform = `translate(${panX}px, ${panY}px) scale(${zoom})`; }
            function getTouchDistance(touches) { const dx = touches[0].clientX - touches[1].clientX; const dy = touches[0].clientY - touches[1].clientY; return Math.sqrt(dx * dx + dy * dy); }
            function getTouchCenter(touches) { return { x: (touches[0].clientX + touches[1].clientX) / 2, y: (touches[0].clientY + touches[1].clientY) / 2 }; }

            function startDrawing(e) {
                if (e.touches && e.touches.length === 2) {
                    e.preventDefault(); isDrawing = false; isPanning = true;
                    lastTouchDistance = getTouchDistance(e.touches);
                    touchCenter = getTouchCenter(e.touches);
                    panStart = { x: touchCenter.x - panX, y: touchCenter.y - panY };
                    return;
                }
                if (currentTool === 'pan') {
                    isPanning = true;
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    panStart = { x: clientX - panX, y: clientY - panY };
                    container.classList.add('is-panning');
                    return;
                }
                isDrawing = true; startPos = getTransformedPointerPos(e); currentStroke = [startPos];
            }

            function draw(e) {
                if (e.touches && e.touches.length === 2) {
                    e.preventDefault(); if (lastTouchDistance == null) return;
                    const newTouchCenter = getTouchCenter(e.touches);
                    const newTouchDistance = getTouchDistance(e.touches);
                    const zoomFactor = newTouchDistance / lastTouchDistance;
                    adjustZoom(zoomFactor, newTouchCenter.x, newTouchCenter.y);
                    panX = newTouchCenter.x - panStart.x;
                    panY = newTouchCenter.y - panStart.y;
                    applyTransform();
                    lastTouchDistance = newTouchDistance;
                    panStart = { x: newTouchCenter.x - panX, y: newTouchCenter.y - panY };
                    return;
                }
                if (isPanning) {
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    panX = clientX - panStart.x;
                    panY = clientY - panStart.y;
                    applyTransform(); return;
                }
                if (!isDrawing) return; e.preventDefault(); const currentPos = getTransformedPointerPos(e); if (currentTool === 'eraser') { const lastPos = currentStroke[currentStroke.length - 1]; applyToolStyles(mainCtx); mainCtx.beginPath(); mainCtx.moveTo(lastPos.x, lastPos.y); mainCtx.lineTo(currentPos.x, currentPos.y); mainCtx.stroke(); currentStroke.push(currentPos); } else { currentStroke.push(currentPos); tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height); switch (currentTool) { case 'pencil': case 'marker': drawSmoothedLine(tempCtx, currentStroke); break; case 'line': drawLine(tempCtx, startPos, currentPos); break; case 'rectangle': drawRectangle(tempCtx, startPos, currentPos); break; } }
            }
            function stopDrawing() { lastTouchDistance = null; touchCenter = null; if (isPanning) { isPanning = false; container.classList.remove('is-panning'); return; } if (!isDrawing) return; isDrawing = false; tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height); if (currentStroke.length < 3 && ['pencil', 'marker', 'eraser'].includes(currentTool)) { drawDot(mainCtx, startPos); } else if (currentTool !== 'eraser') { switch (currentTool) { case 'pencil': case 'marker': drawSmoothedLine(mainCtx, currentStroke); break; case 'line': drawLine(mainCtx, startPos, currentStroke[currentStroke.length - 1]); break; case 'rectangle': drawRectangle(mainCtx, startPos, currentStroke[currentStroke.length - 1]); break; } } saveState(); saveCurrentPageDrawing(); }
            function drawDot(ctx, pos) { applyToolStyles(ctx); ctx.beginPath(); ctx.arc(pos.x, pos.y, ctx.lineWidth / 2, 0, Math.PI * 2); ctx.fill(); }

            function applyToolStyles(ctx) {
                const toolConfig = toolSettings[currentTool];
                ctx.lineWidth = toolConfig.size;
                if (currentTool === 'eraser') {
                    ctx.globalCompositeOperation = 'destination-out';
                } else {
                    const color = hexToRgbaString(toolConfig.color, toolConfig.opacity);
                    ctx.strokeStyle = color;
                    ctx.fillStyle = color;
                    ctx.globalCompositeOperation = (currentTool === 'marker') ? 'multiply' : 'source-over';
                }
                ctx.lineCap = (currentTool === 'marker') ? 'butt' : 'round';
                ctx.lineJoin = 'round';
            }

            function drawSmoothedLine(ctx, points) { if (points.length < 2) return; applyToolStyles(ctx); ctx.beginPath(); ctx.moveTo(points[0].x, points[0].y); for (let i = 1; i < points.length - 2; i++) { const c = (points[i].x + points[i + 1].x) / 2; const d = (points[i].y + points[i + 1].y) / 2; ctx.quadraticCurveTo(points[i].x, points[i].y, c, d); } if (points.length > 1) { ctx.quadraticCurveTo(points[points.length - 2].x, points[points.length - 2].y, points[points.length - 1].x, points[points.length - 1].y); } ctx.stroke(); }
            function drawLine(ctx, start, end) { applyToolStyles(ctx); ctx.beginPath(); ctx.moveTo(start.x, start.y); ctx.lineTo(end.x, end.y); ctx.stroke(); }
            function drawRectangle(ctx, start, end) { applyToolStyles(ctx); ctx.beginPath(); ctx.rect(start.x, start.y, end.x - start.x, end.y - start.y); ctx.stroke(); }

            // --- Event Listeners ---
            container.addEventListener('mousedown', startDrawing); container.addEventListener('mousemove', draw); window.addEventListener('mouseup', stopDrawing); container.addEventListener('touchstart', startDrawing, { passive: false }); container.addEventListener('touchmove', draw, { passive: false }); window.addEventListener('touchend', stopDrawing);
            document.addEventListener('mousemove', e => { customCursor.style.left = `${e.clientX}px`; customCursor.style.top = `${e.clientY}px`; });
            sideBar.addEventListener('mouseenter', () => document.body.classList.add('sidebar-hover')); sideBar.addEventListener('mouseleave', () => document.body.classList.remove('sidebar-hover'));
            toolButtons.forEach(button => { button.addEventListener('click', () => { currentTool = button.id; toolButtons.forEach(btn => btn.classList.remove('active')); button.classList.add('active'); updateUIForTool(currentTool); }); });
            colorPickerTrigger.addEventListener('click', () => colorPickerInput.click());
            colorPickerInput.addEventListener('input', e => { const newColor = e.target.value; if (toolSettings[currentTool].color !== undefined) toolSettings[currentTool].color = newColor; updateActiveColorSwatch(newColor); updateCustomCursor(); });
            function selectColor(color) { if (toolSettings[currentTool].color !== undefined) toolSettings[currentTool].color = color; colorPickerInput.value = color; updateActiveColorSwatch(color); updateCustomCursor(); }
            colorSwatches.forEach(swatch => swatch.addEventListener('click', () => selectColor(swatch.dataset.color)));
            addCustomColorBtn.addEventListener('click', () => { const newColor = colorPickerInput.value; if (!customColors.includes(newColor)) { if (customColors.length >= MAX_CUSTOM_COLORS) { customColors.shift(); } customColors.push(newColor); saveCustomColors(); renderCustomColors(); selectColor(newColor); } });
            function renderCustomColors() { customColorsPalette.innerHTML = ''; customColors.forEach(color => { const swatch = document.createElement('button'); swatch.className = 'color-swatch'; swatch.style.backgroundColor = color; swatch.dataset.color = color; swatch.addEventListener('click', () => selectColor(color)); customColorsPalette.appendChild(swatch); }); }
            function saveCustomColors() { localStorage.setItem('geniusCustomColors', JSON.stringify(customColors)); }
            function loadCustomColors() { const saved = localStorage.getItem('geniusCustomColors'); if (saved) { customColors = JSON.parse(saved); renderCustomColors(); } }
            function handleSliderInput(slider, valueSpan, isOpacity) { const value = parseFloat(slider.value); toolSettings[currentTool][isOpacity ? 'opacity' : 'size'] = value; valueSpan.textContent = isOpacity ? `${Math.round(value * 100)}%` : `${Math.round(value)}px`; updateCustomCursor(); }
            brushSizeSlider.addEventListener('input', () => handleSliderInput(brushSizeSlider, brushSizeValue, false)); opacitySlider.addEventListener('input', () => handleSliderInput(opacitySlider, opacityValue, true));
            clearBtn.addEventListener('click', () => { mainCtx.clearRect(0, 0, mainCanvas.width, mainCanvas.height); history = [mainCanvas.toDataURL()]; historyStep = 0; saveHistoryForCurrentPage(); delete drawingsData[currentPage]; saveCurrentPageDrawing(); });
            downloadBtn.addEventListener('click', () => { const link = document.createElement('a'); link.download = `apuntes-pagina-${currentPage}.png`; const tempC = document.createElement('canvas'); tempC.width = backgroundImage.naturalWidth; tempC.height = backgroundImage.naturalHeight; const temp_ctx = tempC.getContext('2d'); temp_ctx.drawImage(backgroundImage, 0, 0); temp_ctx.drawImage(mainCanvas, 0, 0); link.href = tempC.toDataURL(); link.click(); });
            undoBtn.addEventListener('click', undoState); redoBtn.addEventListener('click', redoState); menuToggle.addEventListener('click', () => { sideBar.classList.contains('collapsed') ? expandMenu() : collapseMenu(); }); focusModeBtn.addEventListener('click', enterFocusMode); exitFocusModeBtn.addEventListener('click', exitFocusMode);
            prevBtn.addEventListener('click', () => loadPage(currentPage - 1)); nextBtn.addEventListener('click', () => loadPage(currentPage + 1)); pageInput.addEventListener('change', () => loadPage(pageInput.value));
            galleryBtn.addEventListener('click', openGallery); galleryModal.addEventListener('click', (e) => { if (e.target === galleryModal) closeGallery(); });
            zoomInBtn.addEventListener('click', () => adjustZoom(1.2)); zoomOutBtn.addEventListener('click', () => adjustZoom(0.8)); zoomResetBtn.addEventListener('click', fitAndCenter);
            container.addEventListener('wheel', (e) => { e.preventDefault(); if (e.ctrlKey) { const zoomFactor = e.deltaY > 0 ? 0.95 : 1.05; adjustZoom(zoomFactor, e.clientX, e.clientY); } else { panY -= e.deltaY; panX -= e.deltaX; applyTransform(); } }, { passive: false });

            if (toggleToolsBtn) {
                toggleToolsBtn.addEventListener('click', () => {
                    sideBar.classList.toggle('mobile-hidden');
                    toggleToolsBtn.classList.toggle('active');
                });
            }

            function adjustZoom(factor, x, y) {
                const newZoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, zoom * factor)); if (newZoom === zoom) return;
                const rect = container.getBoundingClientRect();
                const mouseX = x === undefined ? rect.width / 2 : x;
                const mouseY = y === undefined ? rect.height / 2 : y;
                panX = mouseX - (mouseX - panX) * (newZoom / zoom);
                panY = mouseY - (mouseY - panY) * (newZoom / zoom);
                zoom = newZoom;
                updateCustomCursor(); applyTransform();
            }

            function fitAndCenter() {
                const containerWidth = container.clientWidth;
                const containerHeight = container.clientHeight;
                const imageWidth = backgroundImage.naturalWidth;
                const imageHeight = backgroundImage.naturalHeight;
                if (!imageWidth || !imageHeight) return;

                let sidebarWidth = 0;
                let bottomBarHeight = 0;

                if (window.innerWidth > 768) {
                    sidebarWidth = sideBar.classList.contains('collapsed') ? 88 : 256;
                } else {
                    bottomBarHeight = document.getElementById('bottom-controls').offsetHeight;
                }

                const availableWidth = containerWidth - sidebarWidth;
                const availableHeight = containerHeight - bottomBarHeight;

                const scaleX = availableWidth / imageWidth;
                const scaleY = availableHeight / imageHeight;
                zoom = Math.min(scaleX, scaleY) * 0.95;
                panX = sidebarWidth + (availableWidth - imageWidth * zoom) / 2;
                panY = (availableHeight - imageHeight * zoom) / 2;
                applyTransform();
            }

            function openGallery() {
                galleryGrid.innerHTML = '';
                for (let i = 1; i <= totalPages; i++) { const item = document.createElement('div'); item.className = 'gallery-item'; item.textContent = i; if (i === currentPage) item.classList.add('active'); item.addEventListener('click', () => { loadPage(i); closeGallery(); }); galleryGrid.appendChild(item); }
                galleryModal.style.display = 'flex';
            }
            function closeGallery() { galleryModal.style.display = 'none'; }

            // --- Inicialización ---
            window.addEventListener('resize', fitAndCenter);
            document.querySelectorAll('.sidebar-item').forEach((item, index) => { item.style.animationDelay = `${index * 0.05}s`; });
            loadDrawingsFromStorage(); loadCustomColors(); loadPage(1); document.getElementById('pan').click();
        });
    </script>
</body>

</html>
