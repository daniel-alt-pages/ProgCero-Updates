<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plantilla de Plataforma Educativa</title>
    <!-- Dependencias externas -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --color-bg: #0a192f;
            --color-surface: #112240;
            --color-primary-start: #a259ff;
            --color-primary-end: #6c12e5;
            --color-secondary-start: #00aaff;
            --color-secondary-end: #0077cc;
            --color-text: #ccd6f6;
            --color-text-muted: #8892b0;
            --color-border: rgba(172, 126, 255, 0.2);
            --color-glass-surface: rgba(17, 34, 64, 0.7);
        }

        .light-theme {
            --color-bg: #f0f2f5;
            --color-surface: #ffffff;
            --color-text: #1c1e21;
            --color-text-muted: #606770;
            --color-border: rgba(0, 0, 0, 0.1);
            --color-glass-surface: rgba(255, 255, 255, 0.8);
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        .cursor-dot, .cursor-trail {
            position: fixed;
            top: 0;
            left: 0;
            pointer-events: none;
            border-radius: 50%;
            z-index: 9999;
            transform: translate(-50%, -50%);
        }
        .cursor-dot {
            width: 8px;
            height: 8px;
            background-color: var(--color-primary-start);
            transition: transform 0.1s ease-out;
        }
        .cursor-trail {
            background-color: var(--color-primary-start);
            opacity: 1;
            animation: trailAnim 0.5s linear forwards;
        }
        @keyframes trailAnim {
            from { transform: translate(-50%, -50%) scale(1); opacity: 0.7; }
            to { transform: translate(-50%, -50%) scale(0); opacity: 0; }
        }

        .glassmorphism {
            background: var(--color-glass-surface);
            backdrop-filter: blur(10px);
            border: 1px solid var(--color-border);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--color-bg); }
        ::-webkit-scrollbar-thumb { background: linear-gradient(var(--color-secondary-start), var(--color-secondary-end)); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: linear-gradient(var(--color-primary-start), var(--color-primary-end)); }

        .form-input {
            background-color: var(--color-bg);
            border: 1px solid var(--color-border);
            color: var(--color-text);
            transition: all 0.3s ease;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--color-primary-start);
            box-shadow: 0 0 0 3px rgba(162, 89, 255, 0.3);
        }

        .btn { @apply font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105; }
        .btn-primary { background-image: linear-gradient(to right, var(--color-primary-start), var(--color-primary-end)); @apply text-white shadow-lg; }
        .btn-danger { @apply bg-red-600 hover:bg-red-500 text-white shadow-lg shadow-red-500/20; }
        .btn-secondary { @apply bg-slate-600 hover:bg-slate-500 text-white; }
        
        .bg-surface { background-color: var(--color-surface); }
        .text-main { color: var(--color-text); }
        .text-muted { color: var(--color-text-muted); }
        .border-main { border-color: var(--color-border); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .main-view-enter { animation: fadeIn 500ms ease-out forwards; }
        
        .progress-bar-container { background-color: var(--color-bg); border-radius: 9999px; height: 8px; width: 100%; overflow: hidden; }
        .progress-bar { background-image: linear-gradient(to right, var(--color-primary-start), var(--color-secondary-start)); height: 100%; border-radius: 9999px; transition: width 0.5s ease-in-out; }
        
        .table-wrapper { overflow-x: auto; }
        .users-table .sticky-col { position: sticky; z-index: 10; }
        .users-table .first-col { left: 0; border-right: 2px solid var(--color-border); }
        .users-table .last-col { right: 0; border-left: 2px solid var(--color-border); }
        .users-table th.sticky-col, .users-table td.sticky-col { background-color: var(--color-surface); }
        
        .lesson-card {
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .lesson-card.selected {
            border-color: var(--color-primary-start);
            background-color: rgba(162, 89, 255, 0.1);
        }
        .lesson-card.completed {
            opacity: 0.6;
        }
        .tab-btn {
            padding-bottom: 8px;
            border-bottom: 2px solid transparent;
            color: var(--color-text-muted);
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .tab-btn:hover {
            color: var(--color-text);
        }
        .tab-btn.active-tab {
            color: var(--color-primary-start);
            border-bottom-color: var(--color-primary-start);
        }
    </style>
</head>
<body class="antialiased">
    <div id="app-container" class="relative z-10">
        <div id="loader" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-[100]">
            <div class="flex flex-col items-center">
                <i class="fas fa-graduation-cap text-6xl text-[var(--color-primary-start)] animate-pulse"></i>
                <p class="text-white mt-4 text-lg">Cargando plataforma...</p>
            </div>
        </div>
        <div id="toast-container" class="fixed top-5 right-5 z-[90] space-y-3"></div>
        <div id="login-view" class="min-h-screen flex items-center justify-center p-4 bg-cover bg-center hidden" style="background-image: linear-gradient(rgba(10, 25, 47, 0.9), rgba(10, 25, 47, 0.9)), url('https://placehold.co/1920x1080/0a192f/66b3ff?text=Code');">
            <div class="w-full max-w-md p-8 space-y-8 rounded-xl shadow-2xl glassmorphism transition-all duration-500 hover:shadow-[var(--color-primary-start)]/20">
                <div class="text-center">
                    <i class="fas fa-graduation-cap text-6xl text-[var(--color-primary-start)]"></i>
                    <h1 class="text-4xl font-bold text-main mt-4">Portal Educativo</h1>
                    <p class="text-muted mt-2">Inicia sesión para expandir tu conocimiento</p>
                </div>
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="usuario" class="text-sm font-bold text-muted">Usuario</label>
                        <div class="relative mt-2">
                            <span class="absolute left-3.5 top-3.5 text-muted"><i class="fas fa-user-astronaut"></i></span>
                            <input type="text" id="usuario" placeholder="tu@email.com" class="w-full pl-10 p-3 rounded-lg form-input" required>
                        </div>
                    </div>
                    <div>
                        <label for="contrasena" class="text-sm font-bold text-muted">Contraseña</label>
                        <div class="relative mt-2">
                            <span class="absolute left-3.5 top-3.5 text-muted"><i class="fas fa-key"></i></span>
                            <input type="password" id="contrasena" placeholder="••••••••" class="w-full pl-10 p-3 rounded-lg form-input" required>
                        </div>
                         <div class="text-right mt-2">
                            <a href="#" id="forgot-password-link" class="text-sm text-cyan-400 hover:underline">¿Olvidaste tu contraseña?</a>
                        </div>
                    </div>
                    <button type="submit" id="login-button" class="w-full flex justify-center items-center py-3 px-4 btn btn-primary">
                        <span class="button-text">Acceder</span>
                        <svg class="animate-spin h-5 w-5 text-white hidden ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </form>
            </div>
        </div>

        <div id="main-view" class="hidden">
            <header class="p-4 flex justify-between items-center sticky top-0 z-50 glassmorphism">
                <h1 class="text-xl font-bold text-main"><i class="fas fa-graduation-cap text-[var(--color-primary-start)]"></i> Portal Educativo</h1>
                <div class="flex items-center gap-4">
                    <button id="theme-toggle" class="btn btn-secondary text-lg w-10 h-10 flex items-center justify-center"><i class="fas"></i></button>
                    <span id="user-greeting" class="font-semibold text-main hidden md:block"></span>
                    <button id="home-button" class="btn btn-secondary hidden"><i class="fas fa-home"></i><span class="ml-2 hidden md:inline">Inicio</span></button>
                    <div id="profile-menu-button" class="relative cursor-pointer">
                        <img id="user-avatar" src="https://placehold.co/40x40/0a192f/FFFFFF?text=U" class="w-10 h-10 rounded-full border-2 border-[var(--color-primary-start)]">
                    </div>
                    <button id="logout-button" class="btn btn-danger"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </header>
            <main class="p-4 md:p-8">
                
                <div id="student-view" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        <div class="lg:col-span-4 space-y-6">
                            <div class="bg-surface p-6 rounded-xl shadow-lg">
                                <h2 class="text-xl font-bold text-main mb-4">Tu Progreso</h2>
                                <div class="flex items-center justify-center gap-6">
                                    <div id="progress-ring-container" class="relative w-32 h-32"></div>
                                    <div>
                                        <p class="text-3xl font-bold text-main" id="total-progress-percentage">0%</p>
                                        <p class="text-muted" id="total-progress-lessons">0 de 0 clases</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-surface p-4 rounded-xl shadow-lg">
                                <h2 class="text-xl font-bold text-main mb-3 px-2">Contenido del Curso</h2>
                                <div id="lessons-container" class="space-y-2 max-h-[60vh] overflow-y-auto pr-2"></div>
                            </div>
                        </div>
                        <div class="lg:col-span-8 space-y-6">
                            <h2 id="video-title" class="text-3xl font-bold text-main">Selecciona una clase para comenzar</h2>
                            <div class="bg-surface rounded-xl shadow-lg overflow-hidden">
                                <div class="aspect-video relative">
                                    <iframe id="video-player" class="w-full h-full" src="about:blank" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                                </div>
                            </div>
                            <div id="lesson-details-tabs" class="bg-surface p-6 rounded-xl shadow-lg">
                                <div class="border-b border-main flex space-x-6 mb-4">
                                    <button class="tab-btn active-tab" data-tab="details">Detalles</button>
                                    <button class="tab-btn" data-tab="comments">Comentarios (Simulado)</button>
                                </div>
                                <div id="tab-content-details">
                                    <div id="lesson-details-content" class="text-muted grid grid-cols-2 md:grid-cols-3 gap-4 text-sm mb-4"></div>
                                    <p id="lesson-description" class="text-muted text-sm mb-4"></p>
                                    <div id="lesson-actions-container" class="flex flex-col sm:flex-row gap-4"></div>
                                </div>
                                <div id="tab-content-comments" class="hidden">
                                    <div class="space-y-4">
                                        <div class="flex gap-3">
                                            <img src="https://placehold.co/40x40/112240/a259ff?text=S" class="w-10 h-10 rounded-full" alt="Avatar de usuario">
                                            <div>
                                                <p class="font-semibold text-main text-sm">Sofia Vergara</p>
                                                <p class="text-muted text-xs">¡Excelente explicación sobre las herramientas! Muy útil.</p>
                                            </div>
                                        </div>
                                        <div class="flex gap-3">
                                            <img src="https://placehold.co/40x40/112240/00aaff?text=C" class="w-10 h-10 rounded-full" alt="Avatar de usuario">
                                            <div>
                                                <p class="font-semibold text-main text-sm">Carlos Vives</p>
                                                <p class="text-muted text-xs">Tenía una duda sobre el tema, pero el material complementario la resolvió. ¡Gracias!</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="admin-view" class="hidden">
                    <div class="border-b border-main mb-6">
                        <nav id="admin-tabs" class="flex flex-wrap gap-4">
                           <button data-tab="dashboard" class="admin-tab-btn py-2 px-4 font-semibold border-b-2">Dashboard</button>
                           <button data-tab="tracking" class="admin-tab-btn py-2 px-4 font-semibold border-b-2">Seguimiento</button>
                           <button data-tab="users" class="admin-tab-btn py-2 px-4 font-semibold border-b-2">Gestión de Usuarios</button>
                           <button data-tab="course" class="admin-tab-btn py-2 px-4 font-semibold border-b-2">Gestión de Cursos</button>
                           <button data-tab="settings" class="admin-tab-btn py-2 px-4 font-semibold border-b-2">Configuración</button>
                        </nav>
                    </div>
                    <div id="admin-content-area"></div>
                </div>
                <div id="profile-view" class="hidden max-w-2xl mx-auto">
                     <h2 class="text-3xl font-bold text-main mb-6">Mi Perfil</h2>
                     <div class="bg-surface p-8 rounded-lg space-y-6">
                         <div class="text-center">
                              <img id="profile-img-preview" src="https://placehold.co/128x128/0a192f/FFFFFF?text=U" class="w-32 h-32 rounded-full mx-auto mb-4 border-4 border-[var(--color-primary-start)]" alt="Vista previa del avatar">
                              <p class="text-muted text-sm">Las imágenes deben ser URLs públicas.</p>
                         </div>
                         <form id="profile-form" class="space-y-4">
                              <div><label for="profile-nombre" class="block mb-2 text-sm font-medium">Nombre Completo</label><input type="text" id="profile-nombre" class="w-full p-2.5 rounded-lg form-input" required></div>
                              <div><label for="profile-usuario" class="block mb-2 text-sm font-medium">Usuario / Correo</label><input type="text" id="profile-usuario" class="w-full p-2.5 rounded-lg bg-slate-700 border-slate-600 text-slate-400" disabled></div>
                              <div><label for="profile-img-url" class="block mb-2 text-sm font-medium">URL de Foto de Perfil</label><input type="url" id="profile-img-url" placeholder="https://ejemplo.com/imagen.png" class="w-full p-2.5 rounded-lg form-input"></div>
                              <div><label for="profile-new-password" class="block mb-2 text-sm font-medium">Nueva Contraseña (dejar en blanco para no cambiar)</label><input type="password" id="profile-new-password" class="w-full p-2.5 rounded-lg form-input"></div>
                              <button type="submit" class="w-full py-3 px-4 btn btn-primary">Guardar Cambios</button>
                         </form>
                     </div>
                </div>
            </main>
        </div>
    </div>
    
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-70 hidden z-[60]"></div>
    <div id="modal-container" class="fixed inset-0 flex items-center justify-center hidden z-[70] p-4"></div>
    
    <script>
        // ===================================================================================
        // --- SECCIÓN 1: DATOS INICIALES Y CONFIGURACIÓN ---
        // ===================================================================================
        
        const initialData = {
            users: [
                { id: "admin@seamosgenios.org", usuario:"admin@seamosgenios.org", contrasena:"admin1234", nombre:"Admin Genial", rol:"administrador", fotoUrl:"", telefono: "N/A", pais: "N/A", fechaCreacion: new Date().toISOString(), progreso: {}, status: 'activo', tipoDocumento: 'N/A', numeroDocumento: 'N/A', institucion: 'N/A', tipoPrueba: 'N/A', departamento: 'N/A', emailRecuperacion: 'admin@seamosgenios.org', codigoRecuperacion: 'ADMIN001' },
                { id: "andres@seamosgenios.org", usuario:"andres@seamosgenios.org", contrasena:"1724", nombre:"Andrés el Estudiante", rol:"estudiante", fotoUrl:"", telefono: "3001234567", pais: "Colombia", fechaCreacion: new Date().toISOString(), progreso: {"1-1": true}, status: 'activo', tipoDocumento: 'CC', numeroDocumento: '123456789', institucion: 'Colegio Genios', tipoPrueba: 'SABER11', departamento: 'Antioquia', emailRecuperacion: 'andres.rec@email.com', codigoRecuperacion: 'USER001' }
            ],
            course: {
                semanas: [
                    { 
                        numero: 1, 
                        grabaciones: [
                            {id: "1-1", titulo:"Fundamentos del Aprendizaje", descripcion: "En esta clase exploramos las bases del aprendizaje efectivo y cómo aplicarlas en tu día a día.", link:"https://www.youtube.com/watch?v=rokGy0huYEA", materialLink: "https://www.ejemplo.com/material1.pdf", asignatura: "Metodología", tema: "Técnicas de Estudio", profesor: "Dr. Alexandro", fecha: "2024-08-01", expiracion: null}, 
                            {id: "1-2", titulo:"Herramientas para el Éxito", descripcion: "Descubre las herramientas digitales y conceptuales esenciales que te ayudarán a tener éxito en este curso y más allá.", link:"https://www.youtube.com/watch?v=T5pRlIbr6gg", materialLink: "", asignatura: "Tecnología", tema: "Software Educativo", profesor: "Ing. Sofía", fecha: "2024-08-03", expiracion: "2025-12-31"}
                        ] 
                    },
                    { 
                        numero: 2, 
                        grabaciones: [
                            {id: "2-1", titulo:"Introducción a la Programación", descripcion: "Comienza tu viaje en el mundo del código con los conceptos básicos de la programación.", link:"https://www.youtube.com/watch?v=zOjov-2OZ0E", materialLink: "https://www.ejemplo.com/material2.pdf", asignatura: "Programación", tema: "Algoritmos", profesor: "Ing. Sofía", fecha: "2024-08-08", expiracion: null},
                        ] 
                    }
                ]
            }
        };

        const LOCAL_STORAGE_KEY = 'coursePlatformData_v12';
        const TIPOS_PRUEBA = ["PRESABER", "REPITENTE", "VALIDANTE", "SABER11", "Otro"];
        const TIPOS_DOCUMENTO = ["CC", "TI", "CE", "PA", "NIT", "Otro"];
        const DEPARTAMENTOS_COLOMBIA = ["Amazonas", "Antioquia", "Arauca", "Atlántico", "Bolívar", "Boyacá", "Caldas", "Caquetá", "Casanare", "Cauca", "Cesar", "Chocó", "Córdoba", "Cundinamarca", "Guainía", "Guaviare", "Huila", "La Guajira", "Magdalena", "Meta", "Nariño", "Norte de Santander", "Putumayo", "Quindío", "Risaralda", "San Andrés y Providencia", "Santander", "Sucre", "Tolima", "Valle del Cauca", "Vaupés", "Vichada", "Otro"];

        // ===================================================================================
        // --- SECCIÓN 2: LÓGICA PRINCIPAL DE LA APLICACIÓN ---
        // ===================================================================================
        
        const App = {
            state: { 
                currentUser: null, 
                courseContent: { semanas: [] }, 
                users: [], 
                filteredUsers: [],
            },
            
            elements: {
                loader: document.getElementById('loader'),
                mainView: document.getElementById('main-view'),
                loginView: document.getElementById('login-view'),
                loginForm: document.getElementById('login-form'),
                logoutButton: document.getElementById('logout-button'),
                homeButton: document.getElementById('home-button'),
                userGreeting: document.getElementById('user-greeting'),
                userAvatar: document.getElementById('user-avatar'),
                profileMenuButton: document.getElementById('profile-menu-button'),
                adminTabs: document.getElementById('admin-tabs'),
                adminContentArea: document.getElementById('admin-content-area'),
                modalContainer: document.getElementById('modal-container'),
                modalBackdrop: document.getElementById('modal-backdrop'),
                forgotPasswordLink: document.getElementById('forgot-password-link'),
                themeToggle: document.getElementById('theme-toggle'),
            },

            init() {
                this.showLoader();
                this.initUI();
                
                queueMicrotask(() => {
                    const data = this.loadDataFromStorage();
                    this.state.users = data.users;
                    this.state.filteredUsers = data.users;
                    this.state.courseContent = data.course;
                    
                    const savedUserJSON = localStorage.getItem('currentUser');
                    if (savedUserJSON) {
                        const savedUser = JSON.parse(savedUserJSON);
                        const fullUser = this.state.users.find(u => u.id === savedUser.id);
                        if (fullUser) { 
                            this.state.currentUser = fullUser; 
                            this.initializeAppUI(); 
                        } else { 
                            localStorage.removeItem('currentUser'); 
                            this.switchView('login-view'); 
                        }
                    } else {
                        this.switchView('login-view');
                    }
                    this.hideLoader();
                });
            },

            initUI() {
                this.initCursorEffect();
                this.initTheme();
                this.attachEventListeners();
            },

            loadDataFromStorage() {
                try {
                    const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                    if (storedData) {
                        const parsedData = JSON.parse(storedData);
                        if (parsedData.users && parsedData.course && Array.isArray(parsedData.users)) {
                            parsedData.users.forEach(u => {
                                if (!u.progreso) u.progreso = {};
                                if (!u.status) u.status = 'activo';
                                if (!u.emailRecuperacion) u.emailRecuperacion = u.usuario;
                                if (!u.codigoRecuperacion) u.codigoRecuperacion = this.generateRecoveryCode();
                            });
                            parsedData.course.semanas.forEach(s => {
                                s.grabaciones.forEach(g => {
                                    if (g.expiracion === undefined) g.expiracion = null;
                                    if (g.materialLink === undefined) g.materialLink = "";
                                });
                            });
                            return parsedData;
                        }
                    }
                } catch (error) { 
                    console.error("Error al cargar datos de localStorage:", error);
                }
                return JSON.parse(JSON.stringify(initialData)); 
            },

            saveDataToStorage() {
                try {
                    const dataToStore = { 
                        users: this.state.users, 
                        course: this.state.courseContent 
                    };
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToStore));
                } catch (error) { 
                    this.showToast("No se pudieron guardar los cambios.", "error");
                    console.error("Error guardando en localStorage:", error);
                }
            },

            refreshCurrentView() {
                if(this.state.currentUser) {
                    const updatedCurrentUser = this.state.users.find(u => u.id === this.state.currentUser.id);
                    if(updatedCurrentUser) {
                        this.state.currentUser = updatedCurrentUser;
                        localStorage.setItem('currentUser', JSON.stringify(this.state.currentUser));
                        this.initializeAppUI(false);
                    } else {
                        this.handleLogout();
                        return;
                    }
                }
                
                const adminView = document.getElementById('admin-view');
                if(!adminView.classList.contains('hidden')) {
                    const activeTab = this.elements.adminTabs.querySelector('.admin-tab-btn.active-tab');
                    if(activeTab) {
                       this.handleAdminTabSwitch({target: activeTab}, true);
                    }
                }
            },

            initCursorEffect() {
                const dot = document.createElement('div');
                dot.className = 'cursor-dot';
                document.body.appendChild(dot);
                
                window.addEventListener('mousemove', e => {
                    dot.style.left = `${e.clientX}px`;
                    dot.style.top = `${e.clientY}px`;
                    
                    const trail = document.createElement('div');
                    trail.className = 'cursor-trail';
                    trail.style.left = `${e.clientX}px`;
                    trail.style.top = `${e.clientY}px`;
                    trail.style.width = '4px';
                    trail.style.height = '4px';
                    document.body.appendChild(trail);
                    setTimeout(() => {
                        if(document.body.contains(trail)) {
                            document.body.removeChild(trail)
                        }
                    }, 500);
                });
            },
            
            initTheme() {
                const savedTheme = localStorage.getItem('theme') || 'dark';
                document.body.classList.toggle('light-theme', savedTheme === 'light');
                this.elements.themeToggle.querySelector('i').className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            },

            attachEventListeners() {
                this.elements.loginForm.addEventListener('submit', (e) => this.handleLogin(e));
                this.elements.logoutButton.addEventListener('click', () => this.handleLogout());
                this.elements.homeButton.addEventListener('click', () => this.initializeAppUI());
                this.elements.profileMenuButton.addEventListener('click', () => this.showProfileView());
                this.elements.adminTabs.addEventListener('click', (e) => this.handleAdminTabSwitch(e));
                this.elements.forgotPasswordLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.openForgotPasswordModal();
                });
                this.elements.themeToggle.addEventListener('click', () => this.toggleTheme());
            },

            toggleTheme() {
                const isLight = document.body.classList.toggle('light-theme');
                localStorage.setItem('theme', isLight ? 'light' : 'dark');
                this.elements.themeToggle.querySelector('i').className = isLight ? 'fas fa-moon' : 'fas fa-sun';
            },

            showLoader() { this.elements.loader.classList.remove('hidden'); },
            hideLoader() { this.elements.loader.classList.add('hidden'); },

            switchView(viewId, isRefresh = false) {
                ['student-view', 'admin-view', 'profile-view', 'login-view'].forEach(id => document.getElementById(id)?.classList.add('hidden'));
                const isMainView = viewId !== 'login-view';
                this.elements.mainView.classList.toggle('hidden', !isMainView);
                if (isMainView) {
                    document.getElementById(viewId)?.classList.remove('hidden');
                    if(!isRefresh) this.elements.mainView.classList.add('main-view-enter');
                } else {
                    this.elements.loginView.classList.remove('hidden');
                }
                this.elements.homeButton.classList.toggle('hidden', viewId !== 'profile-view');
            },

            initializeAppUI(doSwitchView = true) {
                if (!this.state.currentUser) return;
                const user = this.state.currentUser;
                this.elements.userGreeting.textContent = `Hola, ${user.nombre.split(' ')[0]}`;
                this.elements.userAvatar.src = user.fotoUrl || `https://placehold.co/40x40/0a192f/FFFFFF?text=${user.nombre.charAt(0)}`;
                this.elements.userAvatar.onerror = () => { this.elements.userAvatar.src = `https://placehold.co/40x40/0a192f/FFFFFF?text=${user.nombre.charAt(0)}`; };
                if (user.rol === 'administrador') { 
                    if(doSwitchView) {
                        this.switchView('admin-view');
                        const lastTab = localStorage.getItem('activeAdminTab') || 'dashboard';
                        const tabButton = this.elements.adminTabs.querySelector(`[data-tab="${lastTab}"]`);
                        this.handleAdminTabSwitch({ target: tabButton || this.elements.adminTabs.querySelector('[data-tab="dashboard"]') });
                    }
                } else { 
                    if(doSwitchView) this.switchView('student-view');
                    this.renderStudentView(); 
                }
            },

            showToast(message, type = 'info') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                const colors = { info: 'bg-blue-500', success: 'bg-green-500', error: 'bg-red-500' };
                toast.className = `p-4 rounded-lg text-white shadow-lg ${colors[type]} toast-enter`;
                toast.textContent = message;
                container.appendChild(toast);
                setTimeout(() => {
                    if (container.contains(toast)) {
                        toast.classList.add('toast-exit');
                        toast.addEventListener('animationend', () => toast.remove());
                    }
                }, 3000);
            },

            handleLogin(e) {
                e.preventDefault();
                const button = this.elements.loginForm.querySelector('button[type="submit"]');
                const buttonText = button.querySelector('.button-text');
                const spinner = button.querySelector('svg');
                buttonText.textContent = 'Verificando...';
                spinner.classList.remove('hidden');
                button.disabled = true;

                const usuario = this.elements.loginForm.usuario.value;
                const contrasena = this.elements.loginForm.contrasena.value;

                setTimeout(() => { 
                    const foundUser = this.state.users.find(u => u.usuario === usuario && u.contrasena === contrasena);
                    if (!foundUser) {
                        this.showToast("Usuario o contraseña incorrectos.", "error");
                    } else if (foundUser.status === 'inactivo') {
                        this.showToast("Tu cuenta está inactiva.", "error");
                    } else {
                        this.showToast("¡Bienvenido!", "success");
                        this.state.currentUser = foundUser;
                        localStorage.setItem('currentUser', JSON.stringify(this.state.currentUser));
                        this.initializeAppUI();
                    }
                    buttonText.textContent = 'Acceder';
                    spinner.classList.add('hidden');
                    button.disabled = false;
                }, 500);
            },
            
            openForgotPasswordModal() {
                // ... (código sin cambios)
            },

            handleLogout() {
                this.state.currentUser = null;
                localStorage.removeItem('currentUser');
                localStorage.removeItem('activeAdminTab');
                this.elements.loginForm.reset();
                this.switchView('login-view');
            },

            showProfileView() {
                this.switchView('profile-view');
                const form = document.getElementById('profile-form');
                form.reset();
                const user = this.state.currentUser;
                if (!user) return;
                form['profile-nombre'].value = user.nombre;
                form['profile-usuario'].value = user.usuario;
                form['profile-img-url'].value = user.fotoUrl || '';
                const imgPreview = document.getElementById('profile-img-preview');
                imgPreview.src = user.fotoUrl || `https://placehold.co/128x128/0a192f/FFFFFF?text=${user.nombre.charAt(0)}`;
                imgPreview.onerror = () => { imgPreview.src = `https://placehold.co/128x128/0a192f/FFFFFF?text=${user.nombre.charAt(0)}`; };
                form.addEventListener('submit', (e) => this.handleUpdateProfile(e), { once: true });
            },
            
            handleUpdateProfile(e) {
                e.preventDefault();
                const form = e.target;
                const userIndex = this.state.users.findIndex(u => u.id === this.state.currentUser.id);
                if (userIndex === -1) return;

                const dataToUpdate = {
                    nombre: form['profile-nombre'].value,
                    fotoUrl: form['profile-img-url'].value,
                };
                const newPassword = form['profile-new-password'].value;
                if (newPassword) dataToUpdate.contrasena = newPassword;

                this.state.users[userIndex] = { ...this.state.users[userIndex], ...dataToUpdate };
                this.state.currentUser = { ...this.state.currentUser, ...dataToUpdate };

                this.saveDataToStorage();
                localStorage.setItem('currentUser', JSON.stringify(this.state.currentUser));
                this.showToast('Perfil actualizado con éxito', 'success');
                this.initializeAppUI(false);
            },
            
            getYoutubeThumbnail(url) {
                if (!url) return 'https://placehold.co/160x90/112240/ccd6f6?text=Video';
                try {
                    const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
                    const match = url.match(youtubeRegex);
                    if (match && match[1]) {
                        return `https://i3.ytimg.com/vi/${match[1]}/mqdefault.jpg`;
                    }
                } catch (e) { console.error("Could not parse video URL for thumbnail:", url); }
                return 'https://placehold.co/160x90/112240/ccd6f6?text=Video';
            },

            formatVideoLink(link) {
                if (!link) return 'about:blank';
                let videoId = null;
                try {
                    const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
                    const match = link.match(youtubeRegex);
                    if (match && match[1]) {
                        videoId = match[1];
                    }
                    
                    if (videoId) {
                        const params = new URLSearchParams({
                            autoplay: 0,
                            controls: 1,
                            modestbranding: 1,
                            rel: 0, 
                            showinfo: 0,
                        });
                        return `https://www.youtube.com/embed/${videoId}?${params.toString()}`;
                    }

                    if (link.includes("drive.google.com")) {
                        return link.replace("/view", "/preview");
                    }
                } catch(e) {
                    console.error("Enlace de video inválido:", link, e);
                }
                return link;
            },

            renderStudentView() {
                const lessonsContainer = document.getElementById('lessons-container');
                if (!lessonsContainer) return;
                lessonsContainer.innerHTML = '';
                
                const allLessons = this.state.courseContent.semanas.flatMap(semana => 
                    semana.grabaciones.map(grabacion => ({...grabacion, semana: semana.numero}))
                );
        
                const totalLessons = allLessons.length;
                const completedLessons = allLessons.filter(lesson => this.state.currentUser.progreso && this.state.currentUser.progreso[lesson.id]).length;
                const progressPercentage = totalLessons > 0 ? Math.round((completedLessons / totalLessons) * 100) : 0;
        
                document.getElementById('total-progress-percentage').textContent = `${progressPercentage}%`;
                document.getElementById('total-progress-lessons').textContent = `${completedLessons} de ${totalLessons} clases`;
                
                const progressRing = document.getElementById('progress-ring-container');
                progressRing.innerHTML = `
                    <svg class="w-full h-full" viewBox="0 0 36 36">
                        <path class="stroke-current text-gray-700" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="3"></path>
                        <path class="stroke-current text-[var(--color-primary-start)] transition-all duration-500" stroke-dasharray="${progressPercentage}, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="3" stroke-linecap="round" transform="rotate(-90 18 18)"></path>
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center text-main font-bold text-lg">${progressPercentage}%</div>
                `;
                
                let currentWeek = 0;
                allLessons.forEach(lesson => {
                    if (lesson.semana !== currentWeek) {
                        currentWeek = lesson.semana;
                        lessonsContainer.innerHTML += `<h3 class="font-bold text-main pt-4 pb-2 px-2">Semana ${currentWeek}</h3>`;
                    }
        
                    const isCompleted = this.state.currentUser.progreso && this.state.currentUser.progreso[lesson.id];
                    const isExpired = lesson.expiracion && new Date(lesson.expiracion) < new Date();
                    const lessonCard = document.createElement('div');
                    lessonCard.className = `lesson-card flex items-center gap-4 p-2 rounded-lg transition cursor-pointer hover:bg-slate-800 ${isCompleted ? 'completed' : ''} ${isExpired ? 'opacity-40 cursor-not-allowed' : ''}`;
                    lessonCard.dataset.lessonId = lesson.id;
                    if (isExpired) lessonCard.setAttribute('disabled', 'true');
        
                    lessonCard.innerHTML = `
                        <img src="${this.getYoutubeThumbnail(lesson.link)}" class="w-24 h-14 object-cover rounded-md flex-shrink-0" alt="Miniatura de ${lesson.titulo}">
                        <div class="flex-grow overflow-hidden">
                            <p class="font-semibold text-sm text-main truncate">${lesson.titulo}</p>
                            <p class="text-xs text-muted">${lesson.profesor}</p>
                        </div>
                        <div class="flex-shrink-0 text-center w-6">
                            ${isCompleted ? '<i class="fas fa-check-circle text-green-500 text-xl"></i>' : '<i class="far fa-circle text-muted text-xl"></i>'}
                        </div>
                    `;
                    lessonsContainer.appendChild(lessonCard);
                });
        
                lessonsContainer.querySelectorAll('.lesson-card:not([disabled])').forEach(card => {
                    card.addEventListener('click', (e) => this.selectClass(e.currentTarget.dataset.lessonId));
                });
                
                document.querySelectorAll('#lesson-details-tabs .tab-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('#lesson-details-tabs .tab-btn').forEach(b => b.classList.remove('active-tab'));
                        btn.classList.add('active-tab');
                        document.getElementById('tab-content-details').classList.toggle('hidden', btn.dataset.tab !== 'details');
                        document.getElementById('tab-content-comments').classList.toggle('hidden', btn.dataset.tab !== 'comments');
                    });
                });
        
                const firstAvailableLesson = allLessons.find(g => !g.expiracion || new Date(g.expiracion) >= new Date());
                if (firstAvailableLesson) {
                    this.selectClass(firstAvailableLesson.id);
                } else {
                    document.getElementById('video-title').textContent = "No hay clases disponibles.";
                    document.getElementById('lesson-details-content').innerHTML = '';
                    document.getElementById('lesson-description').textContent = "";
                }
            },
            
            selectClass(lessonId) {
                let selectedLesson;
                for (const week of this.state.courseContent.semanas) {
                    const lesson = week.grabaciones.find(g => g.id === lessonId);
                    if (lesson) { selectedLesson = lesson; break; }
                }
                if (!selectedLesson) return;
        
                document.querySelectorAll('.lesson-card').forEach(card => {
                    card.classList.toggle('selected', card.dataset.lessonId === lessonId);
                });
        
                document.getElementById('video-player').src = this.formatVideoLink(selectedLesson.link);
                document.getElementById('video-title').textContent = selectedLesson.titulo;
                document.getElementById('lesson-details-content').innerHTML = `
                    <div><strong class="font-semibold text-main">Asignatura:</strong><br><span class="text-muted">${selectedLesson.asignatura}</span></div>
                    <div><strong class="font-semibold text-main">Profesor:</strong><br><span class="text-muted">${selectedLesson.profesor}</span></div>
                    <div><strong class="font-semibold text-main">Fecha:</strong><br><span class="text-muted">${new Date(selectedLesson.fecha).toLocaleDateString()}</span></div>
                `;
                document.getElementById('lesson-description').textContent = selectedLesson.descripcion || "Esta lección no tiene una descripción detallada.";
        
                const actionsContainer = document.getElementById('lesson-actions-container');
                const isCompleted = this.state.currentUser.progreso && this.state.currentUser.progreso[selectedLesson.id];
                actionsContainer.innerHTML = '';
                
                if (selectedLesson.materialLink) {
                    actionsContainer.innerHTML += `<a href="${selectedLesson.materialLink}" target="_blank" class="btn btn-secondary flex-1 text-center"><i class="fas fa-book-open mr-2"></i>Ver Material</a>`;
                }
                
                const completeBtn = document.createElement('button');
                completeBtn.className = `btn ${isCompleted ? 'bg-green-600 hover:bg-green-500' : 'btn-primary'} flex-1 text-center`;
                completeBtn.innerHTML = `<i class="fas ${isCompleted ? 'fa-check-double' : 'fa-check'} mr-2"></i> ${isCompleted ? 'Clase Completada' : 'Marcar como Completada'}`;
                completeBtn.onclick = () => this.toggleLessonProgress(selectedLesson.id);
                actionsContainer.appendChild(completeBtn);
            },
            
            toggleLessonProgress(lessonId) {
                const userIndex = this.state.users.findIndex(u => u.id === this.state.currentUser.id);
                if(userIndex === -1) return;
                
                if (!this.state.users[userIndex].progreso) {
                    this.state.users[userIndex].progreso = {};
                }
                
                this.state.users[userIndex].progreso[lessonId] = !this.state.users[userIndex].progreso[lessonId];
                this.state.currentUser = this.state.users[userIndex];
                
                this.saveDataToStorage();
                
                // For local "real-time" effect, we refresh the admin view if it's active
                if (this.state.currentUser.rol === 'administrador') {
                    this.refreshCurrentView();
                } else {
                    this.renderStudentView(); // Re-render student view
                    this.selectClass(lessonId); // Keep the current class selected
                }
                this.showToast("Progreso actualizado", "success");
            },

            handleAdminTabSwitch(e, isRefresh = false) {
                const tabButton = e.target.closest('.admin-tab-btn');
                if (!tabButton) return;
                const tabName = tabButton.dataset.tab;
                localStorage.setItem('activeAdminTab', tabName);

                this.elements.adminTabs.querySelectorAll('.admin-tab-btn').forEach(btn => {
                    btn.classList.remove('text-[var(--color-primary-start)]', 'border-[var(--color-primary-start)]');
                    btn.classList.add('text-muted', 'border-transparent');
                });
                tabButton.classList.add('text-[var(--color-primary-start)]', 'border-[var(--color-primary-start)]');
                tabButton.classList.remove('text-muted', 'border-transparent');
                
                if(!isRefresh) this.elements.adminContentArea.innerHTML = ''; 

                if (tabName === 'dashboard') this.renderDashboard();
                else if (tabName === 'tracking') this.renderStudentTrackingView();
                else if (tabName === 'users') this.renderUserManagement();
                else if (tabName === 'course') this.renderCourseEditor();
                else if (tabName === 'settings') this.renderSettingsView();
            },
            
            renderDashboard() {
                const totalUsers = this.state.users.length;
                const adminCount = this.state.users.filter(u => u.rol === 'administrador').length;
                const studentCount = totalUsers - adminCount;
                const activeUsers = this.state.users.filter(u => u.status === 'activo').length;
                const recentUsers = [...this.state.users].sort((a,b) => new Date(b.fechaCreacion) - new Date(a.fechaCreacion)).slice(0, 5);
                this.elements.adminContentArea.innerHTML = `
                    <div id="dashboard-content" class="main-view-enter">
                        <h2 class="text-2xl font-bold mb-4 text-main">Dashboard</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                            <div class="bg-surface p-4 rounded-lg flex items-center gap-4"><i class="fas fa-users text-3xl text-[var(--color-primary-start)]"></i><div><p class="text-2xl font-bold text-main">${totalUsers}</p><p class="text-muted">Usuarios Totales</p></div></div>
                            <div class="bg-surface p-4 rounded-lg flex items-center gap-4"><i class="fas fa-user-shield text-3xl text-green-500"></i><div><p class="text-2xl font-bold text-main">${adminCount}</p><p class="text-muted">Admins</p></div></div>
                            <div class="bg-surface p-4 rounded-lg flex items-center gap-4"><i class="fas fa-user-graduate text-3xl text-cyan-400"></i><div><p class="text-2xl font-bold text-main">${studentCount}</p><p class="text-muted">Estudiantes</p></div></div>
                            <div class="bg-surface p-4 rounded-lg flex items-center gap-4"><i class="fas fa-user-check text-3xl text-yellow-400"></i><div><p class="text-2xl font-bold text-main">${activeUsers}</p><p class="text-muted">Usuarios Activos</p></div></div>
                        </div>
                        <h3 class="text-xl font-bold mb-4 text-main">Usuarios Recientes</h3>
                        <div class="bg-surface p-4 rounded-lg"><div class="overflow-x-auto"><table class="w-full text-sm text-left text-main"><thead class="text-xs text-[var(--color-primary-start)] uppercase"><tr><th class="px-6 py-3">Nombre</th><th class="px-6 py-3">Rol</th><th class="px-6 py-3">Estado</th><th class="px-6 py-3">Tipo Prueba</th><th class="px-6 py-3">Fecha Registro</th></tr></thead><tbody>
                        ${recentUsers.map(user => `<tr class="border-b border-main"><td class="px-6 py-4 font-medium">${user.nombre}</td><td class="px-6 py-4">${user.rol}</td><td class="px-6 py-4">${user.status}</td><td class="px-6 py-4">${user.tipoPrueba || 'N/A'}</td><td class="px-6 py-4">${new Date(user.fechaCreacion).toLocaleDateString()}</td></tr>`).join('')}
                        </tbody></table></div></div>
                    </div>`;
            },

            renderStudentTrackingView() {
                const adminContentArea = document.getElementById('admin-content-area');
                adminContentArea.innerHTML = `
                    <div id="tracking-content" class="main-view-enter">
                        <h2 class="text-2xl font-bold mb-6 text-main">Seguimiento de Estudiantes</h2>
                        <div id="student-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        </div>
                    </div>
                `;

                const container = document.getElementById('student-cards-container');
                const students = this.state.users.filter(u => u.rol === 'estudiante');
                const allLessons = this.state.courseContent.semanas.flatMap(s => s.grabaciones);
                const totalLessons = allLessons.length;

                if (students.length === 0) {
                    container.innerHTML = `<p class="text-muted md:col-span-2 lg:col-span-3">No hay estudiantes para mostrar.</p>`;
                    return;
                }

                students.forEach(student => {
                    const completedCount = Object.keys(student.progreso || {}).filter(key => student.progreso[key]).length;
                    const progressPercentage = totalLessons > 0 ? Math.round((completedCount / totalLessons) * 100) : 0;

                    const studentCard = document.createElement('div');
                    studentCard.className = 'bg-surface p-5 rounded-xl shadow-lg flex flex-col';
                    studentCard.innerHTML = `
                        <div class="flex items-center mb-4">
                            <img src="${student.fotoUrl || `https://placehold.co/48x48/0a192f/FFFFFF?text=${student.nombre.charAt(0)}`}" class="w-12 h-12 rounded-full mr-4 border-2 border-main" alt="Avatar de ${student.nombre}">
                            <div class="flex-grow">
                                <h3 class="font-bold text-main">${student.nombre}</h3>
                                <p class="text-xs text-muted">${student.usuario}</p>
                            </div>
                        </div>
                        <div class="flex-grow space-y-2">
                             <div class="flex justify-between items-center text-sm">
                                <span class="font-semibold text-muted">Progreso</span>
                                <span class="font-bold text-main">${progressPercentage}%</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" style="width: ${progressPercentage}%"></div>
                            </div>
                            <p class="text-xs text-muted text-right">${completedCount} de ${totalLessons} clases completadas</p>
                        </div>
                        <div class="mt-4">
                            <button class="btn btn-secondary w-full view-student-details-btn" data-id="${student.id}">Ver Detalles</button>
                        </div>
                    `;
                    container.appendChild(studentCard);
                });

                container.querySelectorAll('.view-student-details-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => this.openStudentProgressModal(e.currentTarget.dataset.id));
                });
            },

            openStudentProgressModal(userId) {
                const student = this.state.users.find(u => u.id === userId);
                if (!student) return;

                let modalContent = `<h3 class="text-2xl font-bold mb-6 text-main">Progreso de ${student.nombre}</h3>`;
                let detailsHtml = '<div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">';

                this.state.courseContent.semanas.forEach(semana => {
                    detailsHtml += `<div><h4 class="font-bold text-main mb-2">Semana ${semana.numero}</h4><ul class="space-y-2 pl-4">`;
                    semana.grabaciones.forEach(lesson => {
                        const isCompleted = student.progreso && student.progreso[lesson.id];
                        detailsHtml += `
                            <li class="flex items-center text-sm">
                                <i class="fas ${isCompleted ? 'fa-check-circle text-green-500' : 'fa-circle text-muted'} w-5 mr-3"></i>
                                <span>${lesson.titulo}</span>
                            </li>
                        `;
                    });
                    detailsHtml += `</ul></div>`;
                });

                detailsHtml += '</div>';
                modalContent += detailsHtml;
                modalContent += `<div class="flex justify-end mt-6"><button class="btn btn-primary cancel-btn">Cerrar</button></div>`;
                
                this.openModal(modalContent);
            },
            
            renderUserManagement() {
                this.elements.adminContentArea.innerHTML = `
                    <div id="users-content" class="main-view-enter">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                            <h2 class="text-2xl font-bold text-main">Usuarios Registrados</h2>
                            <div class="flex items-center gap-2">
                              <button id="export-excel-btn" class="btn btn-secondary"><i class="fas fa-file-excel mr-2"></i>Exportar</button>
                              <button id="open-add-user-modal-btn" class="btn btn-primary"><i class="fas fa-plus mr-2"></i>Crear Usuario</button>
                            </div>
                        </div>
                        <div class="bg-surface p-4 rounded-lg mb-4 flex flex-col md:flex-row gap-4">
                            <input type="text" id="user-search-input" placeholder="Buscar por nombre, email, documento..." class="form-input rounded-lg p-2 flex-grow">
                            <select id="role-filter" class="form-input rounded-lg p-2"><option value="">Todos los Roles</option><option value="administrador">Administrador</option><option value="estudiante">Estudiante</option></select>
                            <select id="status-filter" class="form-input rounded-lg p-2"><option value="">Todos los Estados</option><option value="activo">Activo</option><option value="inactivo">Inactivo</option></select>
                        </div>
                        <div class="bg-surface p-4 rounded-lg"><div class="table-wrapper">
                            <table class="w-full text-sm text-left users-table" style="min-width: 1600px;"><thead class="text-xs text-[var(--color-primary-start)] uppercase"><tr>
                                <th scope="col" class="px-6 py-3 sticky-col first-col min-w-[250px]">Nombre</th>
                                <th scope="col" class="px-6 py-3 min-w-[250px]">Usuario</th>
                                <th scope="col" class="px-6 py-3">Contraseña</th>
                                <th scope="col" class="px-6 py-3">Rol</th>
                                <th scope="col" class="px-6 py-3">Estado</th>
                                <th scope="col" class="px-6 py-3">Teléfono</th>
                                <th scope="col" class="px-6 py-3">Tipo Doc.</th>
                                <th scope="col" class="px-6 py-3">Num. Doc.</th>
                                <th scope="col" class="px-6 py-3">Institución</th>
                                <th scope="col" class="px-6 py-3">Tipo Prueba</th>
                                <th scope="col" class="px-6 py-3">Email Recuperación</th>
                                <th scope="col" class="px-6 py-3 sticky-col last-col text-center min-w-[140px]">Acciones</th>
                            </tr></thead><tbody id="user-list-body" class="text-main"></tbody></table>
                        </div></div>
                    </div>`;
                
                document.getElementById('open-add-user-modal-btn').addEventListener('click', () => this.openAddUserModal());
                document.getElementById('export-excel-btn').addEventListener('click', () => this.exportUsersToExcel());
                ['user-search-input', 'role-filter', 'status-filter'].forEach(id => {
                    document.getElementById(id).addEventListener('input', () => this.applyUserFilters());
                });
                this.applyUserFilters();
            },
            
            applyUserFilters() {
                const searchTerm = document.getElementById('user-search-input').value.toLowerCase();
                const role = document.getElementById('role-filter').value;
                const status = document.getElementById('status-filter').value;
                this.state.filteredUsers = this.state.users.filter(user => {
                    const matchesSearch = !searchTerm || Object.values(user).some(val => String(val).toLowerCase().includes(searchTerm));
                    const matchesRole = !role || user.rol === role;
                    const matchesStatus = !status || user.status === status;
                    return matchesSearch && matchesRole && matchesStatus;
                });
                this.renderUserTable();
            },

            renderUserTable() {
                const userListBody = document.getElementById('user-list-body');
                userListBody.innerHTML = '';
                this.state.filteredUsers.forEach(user => {
                    const row = document.createElement('tr');
                    row.className = `border-b border-main hover:bg-slate-800 ${user.status === 'inactivo' ? 'opacity-50' : ''}`;
                    row.innerHTML = `
                        <td class="px-6 py-4 font-medium sticky-col first-col">${user.nombre}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user.usuario}</td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="flex items-center gap-2"><span class="password-field">••••••••</span><button class="text-muted hover:text-main toggle-password-btn"><i class="fas fa-eye"></i></button></div></td>
                        <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full ${user.rol === 'administrador' ? 'bg-purple-900 text-purple-300' : 'bg-slate-700 text-slate-300'}">${user.rol}</span></td>
                        <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full ${user.status === 'activo' ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'}">${user.status}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap">${user.telefono || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user.tipoDocumento || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user.numeroDocumento || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user.institucion || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user.tipoPrueba || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user.emailRecuperacion || 'N/A'}</td>
                        <td class="px-6 py-4 sticky-col last-col text-center space-x-3">
                            <button class="font-medium text-cyan-400 hover:underline edit-user-btn" data-id="${user.id}"><i class="fas fa-pencil-alt"></i></button>
                            <button class="font-medium text-yellow-400 hover:underline toggle-status-btn" data-id="${user.id}"><i class="fas ${user.status === 'activo' ? 'fa-user-slash' : 'fa-user-check'}"></i></button>
                            <button class="font-medium text-red-400 hover:underline delete-user-btn" data-id="${user.id}" data-name="${user.nombre}"><i class="fas fa-trash"></i></button>
                        </td>`;
                    
                    const toggleBtn = row.querySelector('.toggle-password-btn');
                    const passwordField = row.querySelector('.password-field');
                    toggleBtn.addEventListener('click', () => {
                        if (passwordField.textContent === '••••••••') { passwordField.textContent = user.contrasena; toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i>'; } 
                        else { passwordField.textContent = '••••••••'; toggleBtn.innerHTML = '<i class="fas fa-eye"></i>'; }
                    });

                    userListBody.appendChild(row);
                });

                userListBody.querySelectorAll('.edit-user-btn').forEach(btn => btn.addEventListener('click', (e) => this.openEditUserModal(e.currentTarget.dataset.id)));
                userListBody.querySelectorAll('.toggle-status-btn').forEach(btn => btn.addEventListener('click', (e) => this.toggleUserStatus(e.currentTarget.dataset.id)));
                userListBody.querySelectorAll('.delete-user-btn').forEach(btn => btn.addEventListener('click', (e) => this.confirmDeleteUser(e.currentTarget.dataset.id, e.currentTarget.dataset.name)));
            },
            
            openAddUserModal() {
                this.openModal(`...`); // Modal HTML sin cambios
            },
            
            handleCreateUser(e) {
                e.preventDefault();
                const form = e.target;
                const usuario = form['add-usuario'].value;
                if (this.state.users.some(u => u.usuario === usuario)) {
                    this.showToast('Error: El usuario ya existe.', 'error');
                    return;
                }
                const newUser = { 
                    id: usuario, 
                    usuario, 
                    rol: form['add-rol'].value, 
                    nombre: form['add-nombre'].value, 
                    contrasena: form['add-contrasena'].value, 
                    telefono: form['add-telefono'].value || 'N/A', 
                    emailRecuperacion: form['add-emailRecuperacion'].value || usuario,
                    tipoDocumento: form['add-tipoDocumento'].value || 'N/A', 
                    numeroDocumento: form['add-numeroDocumento'].value || 'N/A',
                    institucion: form['add-institucion'].value || 'N/A', 
                    tipoPrueba: form['add-tipoPrueba'].value || 'N/A', 
                    departamento: form['add-departamento'].value || 'N/A',
                    fotoUrl: '', 
                    status: 'activo', 
                    progreso: {}, 
                    fechaCreacion: new Date().toISOString(), 
                    codigoRecuperacion: this.generateRecoveryCode()
                };
                this.state.users.push(newUser);
                this.saveDataToStorage();
                this.showToast('Usuario creado con éxito', 'success');
                this.closeModal();
                this.applyUserFilters();
            },

            openEditUserModal(userId) {
                // ... (código sin cambios)
            },

            handleUpdateUser(e, userId) {
                e.preventDefault();
                const userIndex = this.state.users.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    const form = e.target;
                    const updatedUser = {
                        ...this.state.users[userIndex],
                        rol: form['edit-rol'].value, 
                        nombre: form['edit-nombre'].value, 
                        telefono: form['edit-telefono'].value || 'N/A',
                        emailRecuperacion: form['edit-emailRecuperacion'].value || 'N/A', 
                        tipoDocumento: form['edit-tipoDocumento'].value || 'N/A',
                        numeroDocumento: form['edit-numeroDocumento'].value || 'N/A', 
                        institucion: form['edit-institucion'].value || 'N/A',
                        tipoPrueba: form['edit-tipoPrueba'].value || 'N/A', 
                        departamento: form['edit-departamento'].value || 'N/A',
                    };
                    const newPassword = form['edit-new-password'].value;
                    if (newPassword) updatedUser.contrasena = newPassword;
                    this.state.users[userIndex] = updatedUser;
                    this.saveDataToStorage();
                    this.showToast('Usuario actualizado', 'success');
                    this.closeModal();
                    this.applyUserFilters();
                }
            },
            
            toggleUserStatus(userId) {
                const userIndex = this.state.users.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    const newStatus = this.state.users[userIndex].status === 'activo' ? 'inactivo' : 'activo';
                    this.state.users[userIndex].status = newStatus;
                    this.saveDataToStorage();
                    this.showToast(`Usuario ${newStatus}`, 'success');
                    this.applyUserFilters();
                }
            },

            confirmDeleteUser(userId, userName) {
                // ... (código sin cambios)
            },

            handleDeleteUser(userId) {
                this.state.users = this.state.users.filter(u => u.id !== userId);
                this.saveDataToStorage();
                this.showToast('Usuario eliminado', 'success');
                this.closeModal();
                this.applyUserFilters();
            },

            exportUsersToExcel() {
                // ... (código sin cambios)
            },
            
            openModal(content) {
                // ... (código sin cambios)
            },
            
            closeModal() {
                // ... (código sin cambios)
            },

            renderCourseEditor() {
                // ... (código sin cambios)
            },

            renderCourseEditorList() {
                // ... (código sin cambios)
            },
            
            openLessonModal(weekIndex, lessonIndex = null) {
                // ... (código sin cambios)
            },

            handleSaveLesson(e, weekIndex, lessonIndex) {
                e.preventDefault();
                const form = e.target;
                const isEditing = lessonIndex !== null;
                const lessonData = { 
                    id: isEditing ? this.state.courseContent.semanas[weekIndex].grabaciones[lessonIndex].id : `${Date.now()}`,
                    titulo: form['lesson-titulo'].value,
                    descripcion: form['lesson-descripcion'].value,
                    link: form['lesson-link'].value,
                    materialLink: form['lesson-material'].value,
                    asignatura: form['lesson-asignatura'].value,
                    tema: form['lesson-tema'].value,
                    profesor: form['lesson-profesor'].value,
                    fecha: form['lesson-fecha'].value,
                    expiracion: form['lesson-expiracion'].value || null,
                };
                if (isEditing) {
                    this.state.courseContent.semanas[weekIndex].grabaciones[lessonIndex] = lessonData;
                } else {
                    this.state.courseContent.semanas[weekIndex].grabaciones.push(lessonData);
                }
                this.saveDataToStorage();
                this.closeModal();
                this.renderCourseEditorList();
            },
            
            renderSettingsView() {
                // ... (código sin cambios)
            },

            confirmResetData() {
                // ... (código sin cambios)
            },

            handleResetData() {
                try { 
                    localStorage.removeItem(LOCAL_STORAGE_KEY); 
                    localStorage.removeItem('currentUser'); 
                    this.showToast('Datos restaurados. Reiniciando...', 'success'); 
                    setTimeout(() => window.location.reload(), 1500); 
                } catch (error) { 
                    this.showToast("No se pudieron restaurar los datos.", "error"); 
                }
            },

            handleAddWeek() {
                const nextWeekNumber = this.state.courseContent.semanas.length > 0 ? Math.max(...this.state.courseContent.semanas.map(s => s.numero)) + 1 : 1;
                this.state.courseContent.semanas.push({ numero: nextWeekNumber, grabaciones: [] });
                this.saveDataToStorage(); 
                this.renderCourseEditorList();
            },

            handleDeleteWeek(weekIndex) {
                this.state.courseContent.semanas.splice(weekIndex, 1);
                this.saveDataToStorage(); 
                this.renderCourseEditorList();
            },

            handleDeleteLesson(weekIndex, lessonIndex) {
                this.state.courseContent.semanas[weekIndex].grabaciones.splice(lessonIndex, 1);
                this.saveDataToStorage(); 
                this.renderCourseEditorList();
            },

            generateRecoveryCode() {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let result = '';
                for (let i = 0; i < 8; i++) { result += chars.charAt(Math.floor(Math.random() * chars.length)); }
                return result;
            },
        };

        // --- INICIO DE LA APLICACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            // Llenar los campos de los modales que se omitieron para brevedad
            App.openForgotPasswordModal = function() {
                this.openModal(`
                    <h3 class="text-2xl font-bold mb-6">Recuperar Contraseña</h3>
                    <div id="recovery-step-1">
                        <p class="mb-4 text-muted">Ingresa tu email de recuperación para verificar tu cuenta.</p>
                        <form id="recovery-step1-form" class="space-y-4">
                            <div><label class="block text-sm mb-1 text-muted">Email de Recuperación</label><input type="email" id="recovery-email" class="w-full p-2 rounded-md form-input" required></div>
                            <div class="flex justify-end gap-4 pt-4"><button type="button" class="btn btn-secondary cancel-btn">Cancelar</button><button type="submit" class="btn btn-primary">Verificar</button></div>
                        </form>
                    </div>
                    <div id="recovery-step-2" class="hidden">
                         <p class="mb-4 text-muted">Ingresa el código de recuperación que te fue proporcionado y tu nueva contraseña.</p>
                         <form id="recovery-step2-form" class="space-y-4">
                            <input type="hidden" id="recovery-user-id">
                            <div><label class="block text-sm mb-1 text-muted">Código de Recuperación</label><input type="text" id="recovery-code" class="w-full p-2 rounded-md form-input" required></div>
                            <div><label class="block text-sm mb-1 text-muted">Nueva Contraseña</label><input type="password" id="recovery-new-password" class="w-full p-2 rounded-md form-input" required></div>
                            <div class="flex justify-end gap-4 pt-4"><button type="button" class="btn btn-secondary cancel-btn">Cancelar</button><button type="submit" class="btn btn-primary">Cambiar Contraseña</button></div>
                         </form>
                    </div>
                `);
                document.getElementById('recovery-step1-form').addEventListener('submit', (e) => { e.preventDefault(); const email = document.getElementById('recovery-email').value; const user = this.state.users.find(u => u.emailRecuperacion === email); if (user) { this.showToast('Usuario verificado.', 'success'); document.getElementById('recovery-step-1').classList.add('hidden'); document.getElementById('recovery-step-2').classList.remove('hidden'); document.getElementById('recovery-user-id').value = user.id; } else { this.showToast('Email no encontrado.', 'error'); } });
                document.getElementById('recovery-step2-form').addEventListener('submit', (e) => { e.preventDefault(); const userId = document.getElementById('recovery-user-id').value; const code = document.getElementById('recovery-code').value; const newPassword = document.getElementById('recovery-new-password').value; const userIndex = this.state.users.findIndex(u => u.id === userId && u.codigoRecuperacion === code); if (userIndex !== -1) { this.state.users[userIndex].contrasena = newPassword; this.saveDataToStorage(); this.showToast('Contraseña actualizada.', 'success'); this.closeModal(); } else { this.showToast('Código incorrecto.', 'error'); } });
            };
            App.openAddUserModal = function() {
                this.openModal(`
                    <h3 class="text-2xl font-bold mb-6 text-main">Crear Nuevo Usuario</h3>
                    <form id="add-user-form" class="space-y-4 max-h-[70vh] overflow-y-auto pr-4 text-muted">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm mb-1">Rol*</label><select id="add-rol" class="w-full p-2 rounded-md form-input"><option value="estudiante">Estudiante</option><option value="administrador">Administrador</option></select></div>
                            <div><label class="block text-sm mb-1">Nombre Completo*</label><input type="text" id="add-nombre" class="w-full p-2 rounded-md form-input" required></div>
                            <div><label class="block text-sm mb-1">Usuario (Email)*</label><input type="email" id="add-usuario" class="w-full p-2 rounded-md form-input" required></div>
                            <div><label class="block text-sm mb-1">Contraseña*</label><input type="password" id="add-contrasena" class="w-full p-2 rounded-md form-input" required></div>
                            <div><label class="block text-sm mb-1">Teléfono</label><input type="tel" id="add-telefono" class="w-full p-2 rounded-md form-input"></div>
                            <div><label class="block text-sm mb-1">Email de Recuperación</label><input type="email" id="add-emailRecuperacion" class="w-full p-2 rounded-md form-input"></div>
                            <div class="md:col-span-2"><hr class="border-main my-2"></div>
                            <div class="md:col-span-2 text-center text-sm">Campos específicos para estudiantes</div>
                            <div><label class="block text-sm mb-1">Tipo de Documento</label><select id="add-tipoDocumento" class="w-full p-2 rounded-md form-input">${TIPOS_DOCUMENTO.map(o => `<option value="${o}">${o}</option>`).join('')}</select></div>
                            <div><label class="block text-sm mb-1">Número de Documento</label><input type="text" id="add-numeroDocumento" class="w-full p-2 rounded-md form-input"></div>
                            <div><label class="block text-sm mb-1">Institución</label><input type="text" id="add-institucion" class="w-full p-2 rounded-md form-input"></div>
                            <div><label class="block text-sm mb-1">Tipo de Prueba</label><select id="add-tipoPrueba" class="w-full p-2 rounded-md form-input">${TIPOS_PRUEBA.map(o => `<option value="${o}">${o}</option>`).join('')}</select></div>
                            <div class="md:col-span-2"><label class="block text-sm mb-1">Departamento</label><select id="add-departamento" class="w-full p-2 rounded-md form-input">${DEPARTAMENTOS_COLOMBIA.map(o => `<option value="${o}">${o}</option>`).join('')}</select></div>
                        </div>
                        <div class="flex justify-end gap-4 pt-4"><button type="button" class="btn btn-secondary cancel-btn">Cancelar</button><button type="submit" class="btn btn-primary">Crear Usuario</button></div>
                    </form>
                `);
                document.getElementById('add-user-form').addEventListener('submit', (e) => this.handleCreateUser(e));
            };
            App.openEditUserModal = function(userId) {
                const user = this.state.users.find(u => u.id === userId);
                if (user) {
                    this.openModal(`
                        <h3 class="text-2xl font-bold mb-6 text-main">Editar Usuario</h3>
                        <form id="edit-user-form" class="space-y-4 max-h-[70vh] overflow-y-auto pr-4 text-muted">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block text-sm mb-1">Rol</label><select id="edit-rol" class="w-full p-2 rounded-md form-input">${['estudiante', 'administrador'].map(o => `<option value="${o}" ${user.rol === o ? 'selected' : ''}>${o}</option>`).join('')}</select></div>
                                <div><label class="block text-sm mb-1">Nombre*</label><input type="text" id="edit-nombre" value="${user.nombre}" class="w-full p-2 rounded-md form-input" required></div>
                                <div><label class="block text-sm mb-1">Teléfono</label><input type="tel" id="edit-telefono" value="${user.telefono}" class="w-full p-2 rounded-md form-input"></div>
                                <div><label class="block text-sm mb-1">Email Recuperación</label><input type="email" id="edit-emailRecuperacion" value="${user.emailRecuperacion}" class="w-full p-2 rounded-md form-input"></div>
                                <div class="md:col-span-2"><label class="block text-sm mb-1">Nueva Contraseña (opcional)</label><input type="password" id="edit-new-password" class="w-full p-2 rounded-md form-input"></div>
                                <div class="md:col-span-2"><hr class="border-main my-2"></div>
                                <div><label class="block text-sm mb-1">Tipo Documento</label><select id="edit-tipoDocumento" class="w-full p-2 rounded-md form-input">${TIPOS_DOCUMENTO.map(o => `<option value="${o}" ${user.tipoDocumento === o ? 'selected' : ''}>${o}</option>`).join('')}</select></div>
                                <div><label class="block text-sm mb-1"># Documento</label><input type="text" id="edit-numeroDocumento" value="${user.numeroDocumento || ''}" class="w-full p-2 rounded-md form-input"></div>
                                <div><label class="block text-sm mb-1">Institución</label><input type="text" id="edit-institucion" value="${user.institucion || ''}" class="w-full p-2 rounded-md form-input"></div>
                                <div><label class="block text-sm mb-1">Tipo Prueba</label><select id="edit-tipoPrueba" class="w-full p-2 rounded-md form-input">${TIPOS_PRUEBA.map(o => `<option value="${o}" ${user.tipoPrueba === o ? 'selected' : ''}>${o}</option>`).join('')}</select></div>
                                <div class="md:col-span-2"><label class="block text-sm mb-1">Departamento</label><select id="edit-departamento" class="w-full p-2 rounded-md form-input">${DEPARTAMENTOS_COLOMBIA.map(o => `<option value="${o}" ${user.departamento === o ? 'selected' : ''}>${o}</option>`).join('')}</select></div>
                            </div>
                            <div class="flex justify-end gap-4 pt-4"><button type="button" class="btn btn-secondary cancel-btn">Cancelar</button><button type="submit" class="btn btn-primary">Guardar Cambios</button></div>
                        </form>
                    `);
                    document.getElementById('edit-user-form').addEventListener('submit', (e) => this.handleUpdateUser(e, userId));
                }
            };
            App.openLessonModal = function(weekIndex, lessonIndex = null) {
                const isEditing = lessonIndex !== null;
                const lesson = isEditing ? this.state.courseContent.semanas[weekIndex].grabaciones[lessonIndex] : {};
                const today = new Date().toISOString().split('T')[0];
                this.openModal(`
                    <h3 class="text-2xl font-bold mb-6 text-main">${isEditing ? 'Editar' : 'Añadir'} Clase</h3>
                    <form id="lesson-form" class="space-y-4 max-h-[70vh] overflow-y-auto pr-4 text-muted">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm mb-1">Asignatura*</label><input type="text" id="lesson-asignatura" value="${lesson.asignatura || ''}" class="w-full p-2 rounded-md form-input" required></div>
                            <div><label class="block text-sm mb-1">Profesor*</label><input type="text" id="lesson-profesor" value="${lesson.profesor || ''}" class="w-full p-2 rounded-md form-input" required></div>
                            <div><label class="block text-sm mb-1">Tema de la Clase*</label><input type="text" id="lesson-tema" value="${lesson.tema || ''}" class="w-full p-2 rounded-md form-input" required></div>
                            <div><label class="block text-sm mb-1">Título del Video*</label><input type="text" id="lesson-titulo" value="${lesson.titulo || ''}" class="w-full p-2 rounded-md form-input" required></div>
                            <div class="md:col-span-2"><label class="block text-sm mb-1">Descripción</label><textarea id="lesson-descripcion" class="w-full p-2 rounded-md form-input h-20">${lesson.descripcion || ''}</textarea></div>
                            <div><label class="block text-sm mb-1">Fecha de la Clase*</label><input type="date" id="lesson-fecha" value="${lesson.fecha || today}" class="w-full p-2 rounded-md form-input" required></div>
                            <div><label class="block text-sm mb-1">Fecha de Expiración (Opcional)</label><input type="date" id="lesson-expiracion" value="${lesson.expiracion || ''}" class="w-full p-2 rounded-md form-input"></div>
                            <div class="md:col-span-2"><label class="block text-sm mb-1">Enlace del Video*</label><input type="url" id="lesson-link" value="${lesson.link || ''}" class="w-full p-2 rounded-md form-input" required placeholder="YouTube o G-Drive"></div>
                            <div class="md:col-span-2"><label class="block text-sm mb-1">Enlace de Material Complementario (Opcional)</label><input type="url" id="lesson-material" value="${lesson.materialLink || ''}" class="w-full p-2 rounded-md form-input" placeholder="https://biblioteca.com/recurso.pdf"></div>
                            <div class="md:col-span-2"><div class="aspect-video bg-black rounded-lg"><iframe id="lesson-preview" class="w-full h-full rounded-lg" src="about:blank"></iframe></div></div>
                        </div>
                        <div class="flex justify-end gap-4 pt-4"><button type="button" class="btn btn-secondary cancel-btn">Cancelar</button><button type="submit" class="btn btn-primary">Guardar Clase</button></div>
                    </form>
                `);
                
                const linkInput = document.getElementById('lesson-link');
                const previewFrame = document.getElementById('lesson-preview');
                const updatePreview = () => { previewFrame.src = this.formatVideoLink(linkInput.value); };
                linkInput.addEventListener('input', updatePreview);
                if (lesson.link) updatePreview();

                document.getElementById('lesson-form').addEventListener('submit', (e) => this.handleSaveLesson(e, weekIndex, lessonIndex));
            };
            App.confirmDeleteUser = function(userId, userName) {
                this.openModal(`<h3 class="text-xl font-bold mb-4 text-main">Eliminar Usuario</h3><p class="mb-6 text-muted">¿Seguro que quieres eliminar a <b>${userName}</b>? Esta acción no se puede deshacer.</p><div class="flex justify-center gap-4"><button type="button" class="btn btn-secondary cancel-btn">Cancelar</button><button id="confirm-delete-btn" class="btn btn-danger">Eliminar</button></div>`);
                document.getElementById('confirm-delete-btn').onclick = () => this.handleDeleteUser(userId);
            };
            App.confirmResetData = function() {
                this.openModal(`<h3 class="text-xl font-bold mb-4 text-main">¿Estás absolutamente seguro?</h3><p class="mb-6 text-muted">Todos los cambios locales se perderán para siempre. ¿Quieres continuar?</p><div class="flex justify-center gap-4"><button type="button" class="btn btn-secondary cancel-btn">Cancelar</button><button id="confirm-reset-btn" class="btn btn-danger">Sí, Restaurar Ahora</button></div>`);
                document.getElementById('confirm-reset-btn').onclick = () => this.handleResetData();
            };

            App.init();
        });
    </script>
</body>
</html>

